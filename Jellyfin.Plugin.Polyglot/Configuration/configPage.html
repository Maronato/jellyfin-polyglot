<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Polyglot</title>
</head>
<body>
    <div id="polyglotConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-collapse">
        <div data-role="content">
            <div class="content-primary">
                <h2>Polyglot</h2>

                <!-- Tabs -->
                <div class="tabs-viewmenubar" style="margin-bottom: 2em;">
                    <button is="emby-button" class="emby-tab-button emby-button-tab active" data-tab="languagesTab">Languages</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="usersTab">Users</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="ldapTab" id="ldapTabButton" style="display: none;">LDAP</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="settingsTab">Settings</button>
            </div>

            <!-- Languages Tab -->
                <div id="languagesTab" class="tabContent active" style="display: block;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Existing Libraries</h3>
                        <div id="librariesList" class="paperList"></div>
                </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Language Alternatives</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddAlternative" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                    </div>
                        <div id="alternativesList" class="paperList"></div>
                </div>
            </div>

            <!-- Users Tab -->
                <div id="usersTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">User Language Assignments</h3>
                        <div id="usersList" class="paperList"></div>
                </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">User Management</h3>
                        <p class="fieldDescription" style="margin-bottom: 1em;">
                            Many users have "Enable access to all libraries" in their Jellyfin profile, which prevents
                            the plugin from managing their library access. Use the button below to enable plugin management
                            for all users at once. This will set each user to "Default libraries" (they see only source
                            libraries, not language-specific mirrors).
                        </p>
                        <button is="emby-button" type="button" class="raised" id="btnEnableAllUsers">
                            <span>Enable Plugin for All Users</span>
                        </button>
                        <div class="fieldDescription" style="margin-top: 0.5em;">
                            This will set EnableAllFolders=false for each user and configure their library access based on language settings.
                        </div>
                    </div>
            </div>

            <!-- LDAP Tab -->
                <div id="ldapTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">LDAP Status</h3>
                        <div id="ldapStatus" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="enableLdapIntegration" type="checkbox" is="emby-checkbox" />
                                <span>Enable LDAP Integration</span>
                            </label>
                            <div class="fieldDescription">Automatically assign languages based on LDAP group membership.</div>
                        </div>
                </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Group Mappings</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddLdapMapping" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                    </div>
                        <div id="ldapMappingsList" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="button" class="raised" id="btnTestLdap">
                            <span>Test LDAP Connection</span>
                        </button>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="button" class="raised button-submit block emby-button" id="btnSaveLdapSettings">
                            <span>Save LDAP Settings</span>
                        </button>
                </div>
            </div>

            <!-- Settings Tab -->
                <div id="settingsTab" class="tabContent" style="display: none;">
                    <form id="settingsForm">
                        <div class="verticalSection">
                            <h3 class="sectionTitle">New User Defaults</h3>
                            <p class="fieldDescription" style="margin-bottom: 1em;">
                                Configure how new users are handled when they are created in Jellyfin.
                            </p>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1em;">
                                <label class="emby-checkbox-label">
                                    <input id="autoManageNewUsers" type="checkbox" is="emby-checkbox" />
                                    <span>Automatically manage new users</span>
                                </label>
                                <div class="fieldDescription">When enabled, newly created users will be automatically added to plugin management with the default language below. LDAP assignments (if enabled) take priority.</div>
                            </div>
                            
                            <div class="selectContainer" style="margin-bottom: 1em;">
                                <label class="selectLabel" for="defaultLanguageAlternative">Default Language for New Users</label>
                                <select id="defaultLanguageAlternative" is="emby-select">
                                    <option value="">Default libraries (source only)</option>
                                </select>
                                <div class="fieldDescription">The language alternative assigned to new users when auto-manage is enabled.</div>
                            </div>
                        </div>

                        <div class="verticalSection">
                            <h3 class="sectionTitle">Sync Behavior</h3>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1em;">
                                <label class="emby-checkbox-label">
                                    <input id="syncAfterLibraryScan" type="checkbox" is="emby-checkbox" checked />
                                    <span>Sync mirrors after library scans</span>
                                </label>
                                <div class="fieldDescription">When enabled, mirrors are automatically synced after Jellyfin completes a library scan. Disable this for large libraries where you prefer to control sync timing via scheduled tasks only.</div>
                            </div>
                        </div>

                        <div class="verticalSection">
                            <h3 class="sectionTitle">File Exclusions</h3>
                            <p class="fieldDescription" style="margin-bottom: 1em;">
                                Customize which files and directories are excluded from mirroring. 
                                Excluded files will not be hardlinked - typically metadata and images that should be language-specific.
                            </p>
                            
                            <div class="inputContainer" style="margin-bottom: 1.5em;">
                                <label class="inputLabel inputLabelUnfocused" for="excludedExtensions" style="display: block; margin-bottom: 0.5em;">Excluded File Extensions</label>
                                <textarea id="excludedExtensions" is="emby-textarea" rows="6" style="font-family: monospace; width: 100%; box-sizing: border-box;"></textarea>
                                <div class="fieldDescription">File extensions to exclude from hardlinking (one per line, include the dot).</div>
                            </div>
                            
                            <div class="inputContainer" style="margin-bottom: 1.5em;">
                                <label class="inputLabel inputLabelUnfocused" for="excludedDirectories" style="display: block; margin-bottom: 0.5em;">Excluded Directory Names</label>
                                <textarea id="excludedDirectories" is="emby-textarea" rows="6" style="font-family: monospace; width: 100%; box-sizing: border-box;"></textarea>
                                <div class="fieldDescription">Directory names to exclude from mirroring (one per line).</div>
                            </div>
                            
                            <button is="emby-button" type="button" class="raised" id="btnResetExclusions">
                                <span>Reset to Defaults</span>
                            </button>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save Settings</span>
                            </button>
                        </div>
                    </form>

                    <div class="verticalSection" style="margin-top: 2em; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 2em;">
                        <h3 class="sectionTitle">Troubleshooting</h3>
                        <p class="fieldDescription" style="margin-bottom: 1em;">
                            Generate a debug report to help diagnose issues. The report includes filesystem diagnostics, hardlink verification, 
                            and recent logs. By default, paths and names are anonymized for privacy when sharing publicly.
                        </p>
                        
                        <div style="margin-bottom: 1em; padding: 1em; background: rgba(255,255,255,0.03); border-radius: 4px;">
                            <div style="font-weight: 500; margin-bottom: 0.5em;">Include in Report (check to include actual values):</div>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="debugIncludeFilePaths" type="checkbox" is="emby-checkbox" />
                                    <span>File paths</span>
                                </label>
                            </div>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="debugIncludeLibraryNames" type="checkbox" is="emby-checkbox" />
                                    <span>Library names</span>
                                </label>
                            </div>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="debugIncludeUserNames" type="checkbox" is="emby-checkbox" />
                                    <span>User details</span>
                                </label>
                            </div>
                            
                            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.8em; padding-top: 0.8em;">
                                <div style="font-weight: 500; margin-bottom: 0.5em;">Diagnostics:</div>
                                
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="debugIncludeFilesystem" type="checkbox" is="emby-checkbox" checked />
                                        <span>Filesystem info (disk space, filesystem type)</span>
                                    </label>
                                </div>
                                
                                <div class="checkboxContainer checkboxContainer-withDescription">
                                    <label class="emby-checkbox-label">
                                        <input id="debugIncludeHardlinks" type="checkbox" is="emby-checkbox" checked />
                                        <span>Hardlink verification</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <button is="emby-button" type="button" class="raised" id="btnGenerateDebugReport">
                            <span class="material-icons" style="margin-right: 0.5em;">bug_report</span>
                            <span>Generate Debug Report</span>
                        </button>
                        
                        <div id="debugReportContainer" style="display: none; margin-top: 1em;">
                            <div style="display: flex; gap: 0.5em; margin-bottom: 0.5em;">
                                <button is="emby-button" type="button" class="raised button-submit" id="btnCopyDebugReport">
                                    <span class="material-icons" style="margin-right: 0.5em;">content_copy</span>
                                    <span>Copy to Clipboard</span>
                                </button>
                                <button is="emby-button" type="button" class="raised" id="btnHideDebugReport">
                                    <span>Hide</span>
                                </button>
                            </div>
                            <div id="debugReportPreview" style="background: rgba(0,0,0,0.3); border-radius: 4px; padding: 1em; max-height: 400px; overflow-y: auto;">
                                <pre style="margin: 0; white-space: pre-wrap; word-break: break-word; font-family: monospace; font-size: 0.85em;"></pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Add Alternative Dialog -->
        <div id="addAlternativeDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Language Alternative</h3>
                <form id="addAlternativeForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="altName">Name</label>
                        <input id="altName" type="text" is="emby-input" required />
                        <div class="fieldDescription">Display name (e.g., "Portuguese")</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="altLanguage">Language</label>
                        <select id="altLanguage" is="emby-select" required></select>
                        <div class="fieldDescription">Select the language for metadata</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="altCountry">Country</label>
                        <select id="altCountry" is="emby-select"></select>
                        <div class="fieldDescription">Select the country for region-specific metadata</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="altDestinationPath">Destination Base Path</label>
                        <div style="display: flex; align-items: center;">
                            <input id="altDestinationPath" type="text" is="emby-input" required placeholder="/media/portuguese" style="flex-grow: 1;" />
                            <button type="button" is="paper-icon-button-light" class="btnBrowseDestination" title="Browse" style="margin-left: 0.5em;">
                                <span class="material-icons folder_open" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div class="fieldDescription">Base path for mirror directories (must be on same filesystem as source)</div>
                    </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addAlternativeDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Mirror Dialog -->
        <div id="addMirrorDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Library Mirror</h3>
                <form id="addMirrorForm">
                    <input type="hidden" id="mirrorAlternativeId" />
                    <div class="selectContainer">
                        <label class="selectLabel" for="mirrorSourceLibrary">Source Library</label>
                        <select id="mirrorSourceLibrary" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetPath">Target Path</label>
                        <div style="display: flex; align-items: center;">
                            <input id="mirrorTargetPath" type="text" is="emby-input" required style="flex-grow: 1;" />
                            <button type="button" is="paper-icon-button-light" class="btnBrowseMirrorPath" title="Browse" style="margin-left: 0.5em;">
                                <span class="material-icons folder_open" aria-hidden="true"></span>
                            </button>
                </div>
                        <div class="fieldDescription">Path where mirrored files will be created (auto-suggested, must be on same filesystem as source)</div>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetName">Library Name (optional)</label>
                        <input id="mirrorTargetName" type="text" is="emby-input" placeholder="Movies (Portuguese)" />
                        <div class="fieldDescription">Name for the new Jellyfin library</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addMirrorDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mirror</button>
                </div>
                </form>
            </div>
        </div>

        <!-- Add LDAP Mapping Dialog -->
        <div id="addLdapMappingDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add LDAP Group Mapping</h3>
                <form id="addLdapMappingForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupDn">Group DN</label>
                        <input id="ldapGroupDn" type="text" is="emby-input" required placeholder="CN=Portuguese Users,OU=Groups,DC=example,DC=com" />
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupName">Group Name (optional)</label>
                        <input id="ldapGroupName" type="text" is="emby-input" placeholder="Portuguese Users" />
                        <div class="fieldDescription">Friendly name, also used for CN matching</div>
                </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="ldapLanguageAlt">Language Alternative</label>
                        <select id="ldapLanguageAlt" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapPriority">Priority</label>
                        <input id="ldapPriority" type="number" is="emby-input" value="0" />
                        <div class="fieldDescription">Higher priority wins when user is in multiple groups</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addLdapMappingDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mapping</button>
                </div>
                </form>
        </div>
    </div>

        <script type="text/javascript">
            var PolyglotConfig = {
                pluginUniqueId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                alternatives: [],
                libraries: [],
                users: [],
                cultures: [],
                countries: [],
                serverConfig: null,
                settings: null,
                ldapStatus: null,
                initialized: false,
                
                // Track initial settings values to detect changes
                initialSettings: null,
                initialLdapEnabled: null,
                
                // Polling for status updates
                pollIntervalId: null,
                pollIntervalMs: 5000, // Poll every 5 seconds
                statusObserver: null,

                // Custom API helpers for plugin-specific endpoints
                apiGet: function(endpoint) {
                    return ApiClient.getJSON(ApiClient.getUrl(endpoint));
                },

                apiPost: function(endpoint, data) {
                    return ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
            });
                },

                apiPostJson: function(endpoint, data) {
                    return ApiClient.ajax({
                        url: ApiClient.getUrl(endpoint),
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        dataType: 'json'
            });
                },

                apiPut: function(endpoint, data) {
                    return ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'PUT',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
                    });
                },

                apiDelete: function(endpoint) {
                    return ApiClient.fetch({
                        url: ApiClient.getUrl(endpoint),
                        type: 'DELETE'
                    });
                },

                // Tab switching
                switchTab: function(tabId) {
                    document.querySelectorAll('.tabContent').forEach(function(tab) {
                        tab.style.display = 'none';
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    document.getElementById(tabId).style.display = 'block';
                    document.getElementById(tabId).classList.add('active');
                    document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
                },

                // Dialog helpers
                showDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'flex';
                    dialog.classList.remove('hide');
                },

                closeDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'none';
                    dialog.classList.add('hide');
                    // Reset form if present
                    var form = dialog.querySelector('form');
                    if (form) {
                        form.reset();
                    }
                },

                browseForPath: function(inputId) {
                    var input = document.getElementById(inputId);
                    var currentPath = input.value || '';
                    
                    var picker = new Dashboard.DirectoryBrowser();
                    picker.show({
                        includeDirectories: true,
                        includeFiles: false,
                        path: currentPath,
                        header: 'Select Destination Folder',
                        callback: function(path) {
                            if (path) {
                                input.value = path;
                            }
                            picker.close();
                        }
                    });
                },

        // Load all UI data from plugin endpoint
                loadUIConfig: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    return this.apiGet('Polyglot/UIConfig').then(function(config) {
                        // Store all data from single response
                        self.libraries = config.Libraries || [];
                        self.alternatives = config.Alternatives || [];
                        self.users = config.Users || [];
                        self.cultures = config.Cultures || [];
                        self.countries = config.Countries || [];
                        self.ldapStatus = config.LdapStatus || {};
                        self.settings = config.Settings || {};
                        self.serverConfig = config.ServerConfig || {};
                        
                        // Render all UI components
                        self.renderLibraries();
                        self.renderAlternatives();
                        self.renderUsers();
                        self.renderLdapStatus();
                        self.renderSettings();
                        self.populateLanguageDropdowns();
                        
                        Dashboard.hideLoadingMsg();
                        return config;
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to load configuration: ' + (e.message || 'Unknown error'));
                    });
                },

                getLanguageDisplayName: function(code) {
                    if (!code) {
                        // Use server default if no code specified
                        if (this.serverConfig && this.serverConfig.PreferredMetadataLanguage) {
                            code = this.serverConfig.PreferredMetadataLanguage;
                        } else {
                            return 'default';
                        }
                    }
                    // Try to find the culture name
                    var culture = this.cultures.find(function(c) {
                        return c.TwoLetterISOLanguageName === code || 
                               c.ThreeLetterISOLanguageName === code ||
                               (c.DisplayName && c.DisplayName.toLowerCase() === code.toLowerCase());
                    });
                    return culture ? culture.DisplayName : code;
                },

                renderLibraries: function() {
                    var self = this;
                        var html = '';
                    this.libraries.forEach(function(lib) {
                            var langDisplay = self.getLanguageDisplayName(lib.PreferredMetadataLanguage);
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody">';
                            html += '<div class="listItemBodyText">' + lib.Name + '</div>';
                            html += '<div class="listItemBodyText secondary">' + (lib.CollectionType || 'mixed') + ' • ' + langDisplay + '</div>';
                            html += '</div>';
                            if (lib.IsMirror) {
                                html += '<span class="material-icons" style="color: #00a4dc;">content_copy</span>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('librariesList').innerHTML = html || '<p class="fieldDescription">No libraries found.</p>';
                },

                renderAlternatives: function() {
                    var self = this;
                        var html = '';
                    this.alternatives.forEach(function(alt) {
                            html += '<div class="listItem" style="flex-wrap: wrap;">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            var langDisplay = self.getLanguageDisplayName(alt.MetadataLanguage);
                            var countryDisplay = alt.MetadataCountry || '';
                            var metadataInfo = langDisplay + (countryDisplay ? ' (' + countryDisplay + ')' : '');
                            html += '<div class="listItemBodyText">' + alt.Name + '</div>';
                            html += '<div class="listItemBodyText secondary">Metadata: ' + metadataInfo + ' • Path: ' + (alt.DestinationBasePath || 'not set') + '</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.showAddMirrorDialog(\'' + alt.Id + '\')"><span class="material-icons add"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.syncAlternative(\'' + alt.Id + '\')"><span class="material-icons sync"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteAlternative(\'' + alt.Id + '\')"><span class="material-icons delete"></span></button>';
                            
                            // Show mirrors
                            if (alt.MirroredLibraries && alt.MirroredLibraries.length > 0) {
                                html += '<div style="width: 100%; padding-left: 1em; margin-top: 0.5em;">';
                                alt.MirroredLibraries.forEach(function(mirror) {
                                    html += '<div class="listItem" style="background: rgba(0,0,0,0.2);">';
                                    html += '<span class="material-icons">subdirectory_arrow_right</span>';
                                    html += '<div class="listItemBody" style="flex: 1;">';
                                    html += '<div class="listItemBodyText">' + mirror.SourceLibraryName + ' → ' + mirror.TargetLibraryName + '</div>';
                                    
                                    // Format status with color indicator
                                    var statusColor = '#888';
                                    var statusIcon = '';
                                    if (mirror.Status === 'Pending') {
                                        statusColor = '#f2b01e';
                                        statusIcon = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">schedule</span>';
                                    } else if (mirror.Status === 'Syncing') {
                                        statusColor = '#00a4dc';
                                        statusIcon = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px; animation: spin 1s linear infinite;">sync</span>';
                                    } else if (mirror.Status === 'Synced') {
                                        statusColor = '#52b54b';
                                        statusIcon = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">check_circle</span>';
                                    } else if (mirror.Status === 'Error') {
                                        statusColor = '#cc3333';
                                        statusIcon = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 4px;">error</span>';
                                    }
                                    
                                    html += '<div class="listItemBodyText secondary">';
                                    html += '<span style="color: ' + statusColor + ';">' + statusIcon + mirror.Status + '</span>';
                                    if (mirror.LastSyncedAt) {
                                        html += ' • Last sync: ' + new Date(mirror.LastSyncedAt).toLocaleString();
                                    }
                                    if (mirror.LastError) {
                                        html += ' • <span style="color: #cc3333;">' + mirror.LastError + '</span>';
                                    }
                                    html += '</div>';
                                    html += '</div>';
                                    html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteMirror(\'' + alt.Id + '\', \'' + mirror.SourceLibraryId + '\')"><span class="material-icons delete"></span></button>';
                                    html += '</div>';
                                });
                                html += '</div>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('alternativesList').innerHTML = html || '<p class="fieldDescription">No language alternatives configured. Click + to add one.</p>';
                },

                renderUsers: function() {
                    var self = this;
                        var html = '';
                    this.users.forEach(function(user) {
                            // Determine status text
                            var statusText = 'Not managed by plugin';
                            if (user.IsPluginManaged) {
                                statusText = user.AssignedAlternativeName || 'Default libraries';
                                if (user.ManuallySet) statusText += ' (manual)';
                            }
                            
                            // Determine current selection value
                            var currentValue = 'disabled';
                            if (user.IsPluginManaged) {
                                currentValue = user.AssignedAlternativeId || 'default';
                            }
                            
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + user.Username + (user.IsAdministrator ? ' (Admin)' : '') + '</div>';
                            html += '<div class="listItemBodyText secondary">' + statusText + '</div>';
                            html += '</div>';
                            html += '<select is="emby-select" onchange="PolyglotConfig.setUserLanguage(\'' + user.Id + '\', this.value)" style="width: auto;">';
                            html += '<option value="disabled"' + (currentValue === 'disabled' ? ' selected' : '') + '>Not managed</option>';
                            html += '<option value="default"' + (currentValue === 'default' ? ' selected' : '') + '>Default libraries</option>';
                            self.alternatives.forEach(function(alt) {
                                html += '<option value="' + alt.Id + '"' + (currentValue === alt.Id ? ' selected' : '') + '>' + alt.Name + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';
                        });
                        document.getElementById('usersList').innerHTML = html || '<p class="fieldDescription">No users found.</p>';
                },

                renderLdapStatus: function() {
                    var self = this;
                    var status = this.ldapStatus;
                    
                    // Only show LDAP tab if plugin is installed
                    var ldapTabButton = document.getElementById('ldapTabButton');
                    if (status && status.IsPluginInstalled) {
                        ldapTabButton.style.display = '';
                        
                        var html = '<div class="listItem"><div class="listItemBody">';
                        html += '<div class="listItemBodyText">LDAP Plugin: ✓ Installed</div>';
                        html += '<div class="listItemBodyText secondary">';
                        html += 'Configured: ' + (status.IsConfigured ? '✓' : '✗');
                        html += ' • Integration: ' + (status.IsIntegrationEnabled ? '✓ Enabled' : '✗ Disabled');
                        if (status.ServerAddress) html += ' • Server: ' + status.ServerAddress;
                        html += '</div>';
                        html += '</div></div>';
                        document.getElementById('ldapStatus').innerHTML = html;
                        
                        // Load the checkbox value from settings
                        var ldapEnabled = this.settings.EnableLdapIntegration || false;
                        document.getElementById('enableLdapIntegration').checked = ldapEnabled;
                        
                        // Store initial value for change detection
                        this.initialLdapEnabled = ldapEnabled;
                        
                        // Render LDAP mappings
                        this.renderLdapMappings();
                    } else {
                        ldapTabButton.style.display = 'none';
                    }
                },

                renderLdapMappings: function() {
                    var self = this;
                    var mappings = this.settings.LdapGroupMappings || [];
                        var html = '';
                        mappings.forEach(function(mapping) {
                            var altName = 'Unknown';
                            self.alternatives.forEach(function(alt) {
                                if (alt.Id === mapping.LanguageAlternativeId) altName = alt.Name;
                            });
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + (mapping.LdapGroupName || mapping.LdapGroupDn) + '</div>';
                            html += '<div class="listItemBodyText secondary">→ ' + altName + ' (Priority: ' + mapping.Priority + ')</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteLdapMapping(\'' + mapping.Id + '\')"><span class="material-icons delete"></span></button>';
                            html += '</div>';
                        });
                        document.getElementById('ldapMappingsList').innerHTML = html || '<p class="fieldDescription">No LDAP group mappings configured.</p>';
                },

                renderSettings: function() {
                    var self = this;
                    var settings = this.settings;
                    
                    // Load new user settings
                    var autoManageNewUsers = settings.AutoManageNewUsers || false;
                    var defaultLangId = settings.DefaultLanguageAlternativeId || '';
                    var syncAfterScan = settings.SyncMirrorsAfterLibraryScan !== false;
                    var extensions = settings.ExcludedExtensions || settings.DefaultExcludedExtensions || [];
                    var directories = settings.ExcludedDirectories || settings.DefaultExcludedDirectories || [];
                    
                    document.getElementById('autoManageNewUsers').checked = autoManageNewUsers;
                    
                    // Populate default language dropdown
                    var select = document.getElementById('defaultLanguageAlternative');
                    select.innerHTML = '<option value="">Default libraries (source only)</option>';
                    this.alternatives.forEach(function(alt) {
                        select.innerHTML += '<option value="' + alt.Id + '">' + alt.Name + '</option>';
                    });
                    
                    // Set selected value
                    if (defaultLangId) {
                        select.value = defaultLangId;
                    }
                    
                    document.getElementById('syncAfterLibraryScan').checked = syncAfterScan;
                    document.getElementById('excludedExtensions').value = extensions.join('\n');
                    document.getElementById('excludedDirectories').value = directories.join('\n');
                    
                    // Store initial values for change detection
                    this.initialSettings = {
                        AutoManageNewUsers: autoManageNewUsers,
                        DefaultLanguageAlternativeId: defaultLangId,
                        SyncMirrorsAfterLibraryScan: syncAfterScan,
                        ExcludedExtensions: extensions.slice(), // copy array
                        ExcludedDirectories: directories.slice() // copy array
                    };
                },
                
                resetExclusionsToDefaults: function() {
                    var defaults = this.settings;
                    if (defaults.DefaultExcludedExtensions && defaults.DefaultExcludedDirectories) {
                        document.getElementById('excludedExtensions').value = defaults.DefaultExcludedExtensions.join('\n');
                        document.getElementById('excludedDirectories').value = defaults.DefaultExcludedDirectories.join('\n');
                        Dashboard.alert('Exclusion settings reset to defaults. Click "Save Settings" to apply.');
                    } else {
                        // Reload config if defaults not available
                        this.loadUIConfig();
                    }
                },

        // Actions
                showAddMirrorDialog: function(altId) {
                    var self = this;
                    var alternative = this.alternatives.find(function(a) { return a.Id === altId; });
                    document.getElementById('mirrorAlternativeId').value = altId;
                    
                    // Get IDs of libraries that already have mirrors in this alternative
                    var alreadyMirroredIds = new Set();
                    if (alternative && alternative.MirroredLibraries) {
                        alternative.MirroredLibraries.forEach(function(m) {
                            alreadyMirroredIds.add(m.SourceLibraryId);
                        });
                    }
                    
                    var select = document.getElementById('mirrorSourceLibrary');
                    select.innerHTML = '';
                    
                    // Filter: not a mirror AND not already mirrored for this alternative
                    var availableLibs = this.libraries.filter(function(lib) { 
                        return !lib.IsMirror && !alreadyMirroredIds.has(lib.Id); 
                    });
                    
                    if (availableLibs.length === 0) {
                        select.innerHTML = '<option value="" disabled>No available libraries</option>';
                        Dashboard.alert('All source libraries already have mirrors for this language alternative.');
                        return;
                    }
                    
                    availableLibs.forEach(function(lib) {
                        select.innerHTML += '<option value="' + lib.Id + '">' + lib.Name + '</option>';
                    });
                    
                    // Auto-suggest target path based on base path + library name
                    this.updateMirrorTargetPath(alternative, availableLibs[0]);
                    
                    // Update path when library selection changes
                    select.onchange = function() {
                        var selectedLib = availableLibs.find(function(lib) { return lib.Id === select.value; });
                        self.updateMirrorTargetPath(alternative, selectedLib);
                    };
                    
                    this.showDialog('addMirrorDialog');
                },
                
                updateMirrorTargetPath: function(alternative, library) {
                    if (!alternative || !library) return;
                    
                    var basePath = alternative.DestinationBasePath || '';
                    var libName = library.Name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    
                    // Remove trailing slash from base path
                    if (basePath.endsWith('/')) {
                        basePath = basePath.slice(0, -1);
                    }
                    
                    var suggestedPath = basePath + '/' + libName;
                    document.getElementById('mirrorTargetPath').value = suggestedPath;
                    
                    // Also suggest library name
                    var targetNameInput = document.getElementById('mirrorTargetName');
                    if (!targetNameInput.value) {
                        targetNameInput.placeholder = library.Name + ' (' + alternative.Name + ')';
                    }
                },

                createAlternative: function() {
                    var self = this;
                    var languageSelect = document.getElementById('altLanguage');
                    var countrySelect = document.getElementById('altCountry');
                    var selectedCulture = this.cultures.find(function(c) { 
                        return c.TwoLetterISOLanguageName === languageSelect.value; 
                    });
                    var selectedCountry = this.countries.find(function(c) { 
                        return c.TwoLetterISORegionName === countrySelect.value; 
                    });
                    
                    // Build language code like "pt-BR" from selections
                    var languageCode = languageSelect.value;
                    if (countrySelect.value) {
                        languageCode += '-' + countrySelect.value;
                    }
                    
                    var data = {
                        Name: document.getElementById('altName').value,
                        LanguageCode: languageCode,
                        MetadataLanguage: languageSelect.value || null,
                        MetadataCountry: countrySelect.value || null,
                        DestinationBasePath: document.getElementById('altDestinationPath').value
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives', data).then(function() {
                        self.closeDialog('addAlternativeDialog');
                        // Reload all data
                        self.loadUIConfig();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create alternative: ' + (e.message || 'Unknown error'));
                    });
                },

                createMirror: function() {
                    var self = this;
                    var altId = document.getElementById('mirrorAlternativeId').value;
                    var alternative = this.alternatives.find(function(a) { return a.Id === altId; });
                    var sourceLibId = document.getElementById('mirrorSourceLibrary').value;
                    var sourceLib = this.libraries.find(function(l) { return l.Id === sourceLibId; });
                    
                    // Use entered name, or auto-generate from source library + alternative
                    var targetName = document.getElementById('mirrorTargetName').value;
                    if (!targetName && sourceLib && alternative) {
                        targetName = sourceLib.Name + ' (' + alternative.Name + ')';
                    }
                    
                    var data = {
                        SourceLibraryId: sourceLibId,
                        TargetPath: document.getElementById('mirrorTargetPath').value,
                        TargetLibraryName: targetName
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives/' + altId + '/Libraries', data).then(function() {
                        self.closeDialog('addMirrorDialog');
                        // Reload all data
                        self.loadUIConfig();
                        Dashboard.alert('Mirror creation started. The library will appear with "Pending" status and update as files are processed.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create mirror: ' + (e.message || 'Unknown error'));
                    });
                },

                syncAlternative: function(altId) {
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives/' + altId + '/Sync', {}).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Sync started. Check the scheduled tasks for progress.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to start sync: ' + e.message);
                    });
                },

                deleteAlternative: function(altId) {
                    var self = this;
                    Dashboard.confirm('Delete this language alternative and all its mirrors?', 'Confirm Delete', function(result) {
                        if (result) {
                            Dashboard.showLoadingMsg();
                            self.apiDelete('Polyglot/Alternatives/' + altId + '?deleteLibraries=true&deleteFiles=true').then(function() {
                                // Reload all data
                                self.loadUIConfig();
                            }).catch(function(e) {
                                Dashboard.hideLoadingMsg();
                                Dashboard.alert('Failed to delete alternative: ' + (e.message || 'Unknown error'));
                            });
                        }
                    });
                },

                deleteMirror: function(altId, sourceLibraryId) {
                    var self = this;
                    Dashboard.confirm('Delete this mirror library? This will remove the Jellyfin library and its hardlinked files.', 'Confirm Delete', function(result) {
                        if (result) {
                            Dashboard.showLoadingMsg();
                            self.apiDelete('Polyglot/Alternatives/' + altId + '/Libraries/' + sourceLibraryId + '?deleteLibrary=true&deleteFiles=true').then(function() {
                                // Reload all data
                                self.loadUIConfig();
                            }).catch(function(e) {
                                Dashboard.hideLoadingMsg();
                                Dashboard.alert('Failed to delete mirror: ' + (e.message || 'Unknown error'));
                            });
                        }
                    });
                },

                setUserLanguage: function(userId, value) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    
                    var requestData = {
                        ManuallySet: true
                    };
                    
                    if (value === 'disabled') {
                        // User is not managed by plugin
                        requestData.IsDisabled = true;
                    } else if (value === 'default') {
                        // Managed, but no specific language (default libraries)
                        requestData.AlternativeId = null;
                        requestData.IsDisabled = false;
                    } else {
                        // Managed with a specific language
                        requestData.AlternativeId = value;
                        requestData.IsDisabled = false;
                    }
                    
                    this.apiPut('Polyglot/Users/' + userId + '/Language', requestData).then(function() {
                        // Reload all data
                        self.loadUIConfig();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to set user language: ' + (e.message || 'Unknown error'));
                    });
                },

                createLdapMapping: function() {
                    var self = this;
                    var data = {
                        LdapGroupDn: document.getElementById('ldapGroupDn').value,
                        LdapGroupName: document.getElementById('ldapGroupName').value || null,
                        LanguageAlternativeId: document.getElementById('ldapLanguageAlt').value,
                        Priority: parseInt(document.getElementById('ldapPriority').value) || 0
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/LdapGroups', data).then(function() {
                        self.closeDialog('addLdapMappingDialog');
                        // Reload all data
                        self.loadUIConfig();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create LDAP mapping: ' + (e.message || 'Unknown error'));
                    });
                },

                deleteLdapMapping: function(id) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    this.apiDelete('Polyglot/LdapGroups/' + id).then(function() {
                        // Reload all data
                        self.loadUIConfig();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to delete LDAP mapping: ' + (e.message || 'Unknown error'));
                    });
                },

                testLdapConnection: function() {
                    var username = prompt('Enter username to test (optional):');
                    Dashboard.showLoadingMsg();
                    var url = 'Polyglot/TestLdap';
                    if (username) {
                        url += '?username=' + encodeURIComponent(username);
                    }
                    this.apiPost(url, {}).then(function(result) {
                        Dashboard.hideLoadingMsg();
                        var msg = result.Message;
                        if (result.UserGroups && result.UserGroups.length > 0) {
                            msg += '\n\nGroups: ' + result.UserGroups.join(', ');
                        }
                        if (result.MatchedLanguage) {
                            msg += '\n\nMatched Language: ' + result.MatchedLanguage;
                        }
                        Dashboard.alert(msg);
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('LDAP test failed: ' + e.message);
                    });
                },

                enableAllUsers: function() {
                    var self = this;
                    Dashboard.confirm(
                        'This will enable plugin management for ALL users, setting them to "Default libraries". ' +
                        'Each user\'s EnableAllFolders will be set to false. Continue?',
                        'Enable Plugin for All Users',
                        function(result) {
                            if (result) {
                                Dashboard.showLoadingMsg();
                                self.apiPostJson('Polyglot/Users/EnableAll', {}).then(function(response) {
                                    Dashboard.alert('Enabled plugin for ' + response.UsersEnabled + ' users.');
                                    // Reload all data
                                    self.loadUIConfig();
                                }).catch(function(e) {
                                    Dashboard.hideLoadingMsg();
                                    Dashboard.alert('Failed to enable users: ' + (e.message || 'Unknown error'));
                                });
                            }
                        }
                    );
                },

                // Helper to compare arrays for equality
                arraysEqual: function(a, b) {
                    if (a.length !== b.length) return false;
                    for (var i = 0; i < a.length; i++) {
                        if (a[i] !== b[i]) return false;
                    }
                    return true;
                },

                saveSettings: function() {
                    var self = this;
                    
                    // Get current form values
                    var currentAutoManage = document.getElementById('autoManageNewUsers').checked;
                    var currentDefaultLang = document.getElementById('defaultLanguageAlternative').value || '';
                    var currentSyncAfterScan = document.getElementById('syncAfterLibraryScan').checked;
                        
                        // Parse exclusion settings (split by newlines, filter empty, trim whitespace)
                        var extensionsText = document.getElementById('excludedExtensions').value;
                        var directoriesText = document.getElementById('excludedDirectories').value;
                        
                    var currentExtensions = extensionsText.split('\n')
                            .map(function(s) { return s.trim(); })
                            .filter(function(s) { return s.length > 0; });
                        
                    var currentDirectories = directoriesText.split('\n')
                            .map(function(s) { return s.trim(); })
                            .filter(function(s) { return s.length > 0; });
                        
                    // Build update request with ONLY changed settings
                    var settingsUpdate = {};
                    var hasChanges = false;
                    
                    if (!this.initialSettings) {
                        // No initial state - send everything (shouldn't happen, but fallback)
                        settingsUpdate.AutoManageNewUsers = currentAutoManage;
                        settingsUpdate.DefaultLanguageAlternativeId = currentDefaultLang || null;
                        settingsUpdate.DefaultLanguageAlternativeIdProvided = true;
                        settingsUpdate.SyncMirrorsAfterLibraryScan = currentSyncAfterScan;
                        settingsUpdate.ExcludedExtensions = currentExtensions;
                        settingsUpdate.ExcludedDirectories = currentDirectories;
                        hasChanges = true;
                    } else {
                        // Only include fields that have changed
                        if (currentAutoManage !== this.initialSettings.AutoManageNewUsers) {
                            settingsUpdate.AutoManageNewUsers = currentAutoManage;
                            hasChanges = true;
                        }
                        
                        if (currentDefaultLang !== this.initialSettings.DefaultLanguageAlternativeId) {
                            settingsUpdate.DefaultLanguageAlternativeId = currentDefaultLang || null;
                            settingsUpdate.DefaultLanguageAlternativeIdProvided = true;
                            hasChanges = true;
                        }
                        
                        if (currentSyncAfterScan !== this.initialSettings.SyncMirrorsAfterLibraryScan) {
                            settingsUpdate.SyncMirrorsAfterLibraryScan = currentSyncAfterScan;
                            hasChanges = true;
                        }
                        
                        if (!this.arraysEqual(currentExtensions, this.initialSettings.ExcludedExtensions)) {
                            settingsUpdate.ExcludedExtensions = currentExtensions;
                            hasChanges = true;
                        }
                        
                        if (!this.arraysEqual(currentDirectories, this.initialSettings.ExcludedDirectories)) {
                            settingsUpdate.ExcludedDirectories = currentDirectories;
                            hasChanges = true;
                        }
                    }
                    
                    if (!hasChanges) {
                        Dashboard.alert('No changes to save.');
                        return;
                    }
                    
                    Dashboard.showLoadingMsg();
                    
                    var updateRequest = {
                        Settings: settingsUpdate
                    };
                    
                    this.apiPostJson('Polyglot/UIConfig', updateRequest).then(function(config) {
                        // Update local state from response
                        self.libraries = config.Libraries || [];
                        self.alternatives = config.Alternatives || [];
                        self.users = config.Users || [];
                        self.settings = config.Settings || {};
                        self.ldapStatus = config.LdapStatus || {};
                        
                        // Update initial settings to the new saved values
                        self.initialSettings = {
                            AutoManageNewUsers: config.Settings.AutoManageNewUsers || false,
                            DefaultLanguageAlternativeId: config.Settings.DefaultLanguageAlternativeId || '',
                            SyncMirrorsAfterLibraryScan: config.Settings.SyncMirrorsAfterLibraryScan !== false,
                            ExcludedExtensions: (config.Settings.ExcludedExtensions || []).slice(),
                            ExcludedDirectories: (config.Settings.ExcludedDirectories || []).slice()
                        };
                        
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Settings saved successfully.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save settings: ' + (e.message || 'Unknown error'));
                    });
                },

                generateDebugReport: function() {
                    var self = this;
                    var btn = document.getElementById('btnGenerateDebugReport');
                    var originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="material-icons" style="margin-right: 0.5em; animation: spin 1s linear infinite;">sync</span><span>Generating...</span>';
                    
                    // Read checkbox values
                    var includeFilePaths = document.getElementById('debugIncludeFilePaths').checked;
                    var includeLibraryNames = document.getElementById('debugIncludeLibraryNames').checked;
                    var includeUserNames = document.getElementById('debugIncludeUserNames').checked;
                    var includeFilesystem = document.getElementById('debugIncludeFilesystem').checked;
                    var includeHardlinks = document.getElementById('debugIncludeHardlinks').checked;
                    
                    var queryParams = [
                        'includeFilePaths=' + includeFilePaths,
                        'includeLibraryNames=' + includeLibraryNames,
                        'includeUserNames=' + includeUserNames,
                        'includeFilesystemDiagnostics=' + includeFilesystem,
                        'includeHardlinkVerification=' + includeHardlinks
                    ].join('&');
                    
                    ApiClient.ajax({
                        type: 'GET',
                        url: ApiClient.getUrl('Polyglot/DebugReport?' + queryParams),
                        dataType: 'json'
                    }).then(function(response) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        
                        self.currentDebugReport = response.Markdown;
                        document.querySelector('#debugReportPreview pre').textContent = response.Markdown;
                        document.getElementById('debugReportContainer').style.display = 'block';
                    }).catch(function(e) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        Dashboard.alert('Failed to generate debug report: ' + (e.message || 'Unknown error'));
                    });
                },

                copyDebugReport: function() {
                    var self = this;
                    if (!self.currentDebugReport) {
                        Dashboard.alert('No debug report generated yet');
                        return;
                    }
                    
                    navigator.clipboard.writeText(self.currentDebugReport).then(function() {
                        Dashboard.alert('Debug report copied to clipboard!');
                    }).catch(function() {
                        // Fallback for older browsers
                        var textarea = document.createElement('textarea');
                        textarea.value = self.currentDebugReport;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            Dashboard.alert('Debug report copied to clipboard!');
                        } catch (e) {
                            Dashboard.alert('Failed to copy. Please select and copy manually.');
                        }
                        document.body.removeChild(textarea);
                    });
                },

                currentDebugReport: null,

                saveLdapSettings: function() {
                    var self = this;
                    var currentLdapEnabled = document.getElementById('enableLdapIntegration').checked;
                    
                    // Check if value has changed
                    if (this.initialLdapEnabled !== null && currentLdapEnabled === this.initialLdapEnabled) {
                        Dashboard.alert('No changes to save.');
                        return;
                    }
                    
                    Dashboard.showLoadingMsg();
                    
                    var updateRequest = {
                        Settings: {
                            EnableLdapIntegration: currentLdapEnabled
                        }
                    };
                    
                    this.apiPostJson('Polyglot/UIConfig', updateRequest).then(function(config) {
                        // Update local state from response
                        self.settings = config.Settings || {};
                        self.ldapStatus = config.LdapStatus || {};
                        
                        // Update initial value for future change detection
                        self.initialLdapEnabled = config.Settings.EnableLdapIntegration || false;
                        
                        // Re-render LDAP status to reflect changes
                        self.renderLdapStatus();
                        
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('LDAP settings saved successfully.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save LDAP settings: ' + (e.message || 'Unknown error'));
                    });
                },

                populateLanguageDropdowns: function() {
                    var self = this;
                    var langSelect = document.getElementById('altLanguage');
                    var countrySelect = document.getElementById('altCountry');
                    
                    // Populate language dropdown
                    langSelect.innerHTML = '<option value="">-- Select Language --</option>';
                    this.cultures.forEach(function(culture) {
                        langSelect.innerHTML += '<option value="' + culture.TwoLetterISOLanguageName + '">' + 
                            culture.DisplayName + ' (' + culture.TwoLetterISOLanguageName + ')</option>';
                    });
                    
                    // Populate country dropdown
                    countrySelect.innerHTML = '<option value="">-- None (Optional) --</option>';
                    this.countries.forEach(function(country) {
                        countrySelect.innerHTML += '<option value="' + country.TwoLetterISORegionName + '">' + 
                            country.DisplayName + ' (' + country.TwoLetterISORegionName + ')</option>';
                    });
                    
                    // Auto-fill name when language changes
                    langSelect.addEventListener('change', function() {
                        var nameInput = document.getElementById('altName');
                        if (!nameInput.value) {
                            var culture = self.cultures.find(function(c) { 
                                return c.TwoLetterISOLanguageName === langSelect.value; 
                            });
                            if (culture) {
                                nameInput.value = culture.DisplayName;
                            }
                        }
                    });
                },

                // Silent refresh - updates status without showing loading indicator
                refreshStatus: function() {
                    var self = this;
                    return this.apiGet('Polyglot/UIConfig').then(function(config) {
                        // Update data
                        self.libraries = config.Libraries || [];
                        self.alternatives = config.Alternatives || [];
                        self.users = config.Users || [];
                        self.ldapStatus = config.LdapStatus || {};
                        self.settings = config.Settings || {};
                        
                        // Re-render only the sections that show status
                        self.renderLibraries();
                        self.renderAlternatives();
                        
                        return config;
                    }).catch(function(e) {
                        // Silent fail for background refresh
                        console.warn('Polyglot: Failed to refresh status:', e);
                    });
                },

                startPolling: function() {
                    var self = this;
                    // Don't start if already polling
                    if (this.pollIntervalId) {
                        return;
                    }
                    
                    console.log('Polyglot: Starting status polling');
                    this.pollIntervalId = setInterval(function() {
                        self.refreshStatus();
                    }, this.pollIntervalMs);
                },

                stopPolling: function() {
                    if (this.pollIntervalId) {
                        console.log('Polyglot: Stopping status polling');
                        clearInterval(this.pollIntervalId);
                        this.pollIntervalId = null;
                    }
                },

                setupStatusObserver: function() {
                    var self = this;
                    var languagesTab = document.getElementById('languagesTab');
                    
                    if (!languagesTab) {
                        return;
                    }
                    
                    // Clean up existing observer if any
                    if (this.statusObserver) {
                        this.statusObserver.disconnect();
                    }
                    
                    // Use IntersectionObserver to detect when Languages tab is visible
                    // This works because display:none elements have zero intersection
                    this.statusObserver = new IntersectionObserver(function(entries) {
                        entries.forEach(function(entry) {
                            if (entry.isIntersecting && entry.intersectionRatio > 0) {
                                // Tab is visible - start polling
                                self.startPolling();
                            } else {
                                // Tab is hidden - stop polling
                                self.stopPolling();
                            }
                        });
                    }, {
                        // Trigger when any part of the element is visible
                        threshold: 0
                    });
                    
                    this.statusObserver.observe(languagesTab);
                },

                init: function() {
                    var self = this;
                    
                    // Load all UI data in a single request
                    this.loadUIConfig();

                    // Only attach event listeners once
                    if (this.initialized) {
                        return;
                    }
                    this.initialized = true;

                    // Tab buttons
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            self.switchTab(this.getAttribute('data-tab'));
                        });
                    });

                    // Add alternative button
                    document.getElementById('btnAddAlternative').addEventListener('click', function() {
                        self.showDialog('addAlternativeDialog');
                    });

                    // Browse destination path buttons
                    document.querySelector('.btnBrowseDestination').addEventListener('click', function() {
                        self.browseForPath('altDestinationPath');
                    });
                    
                    document.querySelector('.btnBrowseMirrorPath').addEventListener('click', function() {
                        self.browseForPath('mirrorTargetPath');
                    });

                    // Add LDAP mapping button
                    document.getElementById('btnAddLdapMapping').addEventListener('click', function() {
                        var select = document.getElementById('ldapLanguageAlt');
                        select.innerHTML = '';
                        self.alternatives.forEach(function(alt) {
                            select.innerHTML += '<option value="' + alt.Id + '">' + alt.Name + '</option>';
                        });
                        self.showDialog('addLdapMappingDialog');
                    });

                    // Enable all users button
                    document.getElementById('btnEnableAllUsers').addEventListener('click', function() {
                        self.enableAllUsers();
                    });

                    // Reset exclusions button
                    document.getElementById('btnResetExclusions').addEventListener('click', function() {
                        self.resetExclusionsToDefaults();
                    });

                    // Debug report buttons
                    document.getElementById('btnGenerateDebugReport').addEventListener('click', function() {
                        self.generateDebugReport();
                    });
                    document.getElementById('btnCopyDebugReport').addEventListener('click', function() {
                        self.copyDebugReport();
                    });
                    document.getElementById('btnHideDebugReport').addEventListener('click', function() {
                        document.getElementById('debugReportContainer').style.display = 'none';
                    });

                    // Test LDAP button
                    document.getElementById('btnTestLdap').addEventListener('click', function() {
                        self.testLdapConnection();
                    });

                    // Save LDAP settings button
                    document.getElementById('btnSaveLdapSettings').addEventListener('click', function() {
                        self.saveLdapSettings();
                    });

                    // Form submissions
                    document.getElementById('addAlternativeForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createAlternative();
                    });

                    document.getElementById('addMirrorForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createMirror();
                    });

                    document.getElementById('addLdapMappingForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createLdapMapping();
                    });

                    document.getElementById('settingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.saveSettings();
                    });

                    // Set up status polling observer for the Languages tab
                    this.setupStatusObserver();
                }
            };

            document.getElementById('polyglotConfigPage').addEventListener('pageshow', function() {
                PolyglotConfig.init();
            });

            // Clean up polling when navigating away from the page
            document.getElementById('polyglotConfigPage').addEventListener('pagehide', function() {
                PolyglotConfig.stopPolling();
                if (PolyglotConfig.statusObserver) {
                    PolyglotConfig.statusObserver.disconnect();
                    PolyglotConfig.statusObserver = null;
                }
            });
    </script>

        <style type="text/css">
            .dialog {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }
            .dialog.hide {
                display: none !important;
            }
            .dialogContent {
                background: #1a1a1a;
                padding: 2em;
                border-radius: 8px;
                min-width: 400px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
            }
            .formDialogFooter {
                display: flex;
                justify-content: flex-end;
                gap: 1em;
                margin-top: 1.5em;
            }
            .tabContent {
                min-height: 200px;
            }
            .emby-tab-button.active {
                border-bottom: 3px solid #00a4dc;
                color: #00a4dc;
                font-weight: 600;
            }
            .emby-tab-button {
                border-bottom: 3px solid transparent;
                transition: border-color 0.2s ease, color 0.2s ease;
            }
            .emby-collapse {
                display: flex;
                align-items: center;
                width: 100%;
                padding: 0.8em 1em;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 4px;
                cursor: pointer;
                text-align: left;
                font-size: 1em;
                color: inherit;
                transition: background 0.2s ease;
            }
            .emby-collapse:hover {
                background: rgba(255,255,255,0.08);
            }
            .emby-collapse::before {
                content: '';
                display: inline-block;
                width: 0;
                height: 0;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 6px solid currentColor;
                margin-right: 0.8em;
                transform: rotate(-90deg);
                transition: transform 0.2s ease;
            }
            .emby-collapse.expanded::before {
                transform: rotate(0deg);
            }
            .collapseTitle {
                font-weight: 500;
            }
            .collapseContent {
                border-left: 2px solid rgba(0,164,220,0.3);
                margin-left: 0.5em;
                margin-top: 1em;
                padding: 1em 1.5em 1.5em 1.5em;
            }
            .collapseContent textarea {
                min-height: 120px;
                resize: vertical;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    </div>
</body>
</html>
