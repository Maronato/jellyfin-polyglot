<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Polyglot</title>
</head>
<body>
    <div id="polyglotConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-collapse">
        <div data-role="content">
            <div class="content-primary">
                <h2>Polyglot</h2>
                <p class="fieldDescription">Create language-specific library mirrors with hardlinked media files and separate metadata.</p>

                <!-- Tabs -->
                <div class="tabs-viewmenubar" style="margin-bottom: 2em;">
                    <button is="emby-button" class="emby-tab-button emby-button-tab active" data-tab="languagesTab">Languages</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="usersTab">Users</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="ldapTab" id="ldapTabButton" style="display: none;">LDAP</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="settingsTab">Settings</button>
            </div>

            <!-- Languages Tab -->
                <div id="languagesTab" class="tabContent active" style="display: block;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Existing Libraries</h3>
                        <div id="librariesList" class="paperList"></div>
                </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Language Alternatives</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddAlternative" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                    </div>
                        <div id="alternativesList" class="paperList"></div>
                </div>
            </div>

            <!-- Users Tab -->
                <div id="usersTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">User Language Assignments</h3>
                        <div id="usersList" class="paperList"></div>
                </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">User Management</h3>
                        <p class="fieldDescription" style="margin-bottom: 1em;">
                            Many users have "Enable access to all libraries" in their Jellyfin profile, which prevents
                            the plugin from managing their library access. Use the button below to enable plugin management
                            for all users at once. This will set each user to "Default libraries" (they see only source
                            libraries, not language-specific mirrors).
                        </p>
                        <button is="emby-button" type="button" class="raised" id="btnEnableAllUsers">
                            <span>Enable Plugin for All Users</span>
                        </button>
                        <div class="fieldDescription" style="margin-top: 0.5em;">
                            This will set EnableAllFolders=false for each user and configure their library access based on language settings.
                        </div>
                    </div>
            </div>

            <!-- LDAP Tab -->
                <div id="ldapTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">LDAP Status</h3>
                        <div id="ldapStatus" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="enableLdapIntegration" type="checkbox" is="emby-checkbox" />
                                <span>Enable LDAP Integration</span>
                            </label>
                            <div class="fieldDescription">Automatically assign languages based on LDAP group membership.</div>
                        </div>
                </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Group Mappings</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddLdapMapping" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                    </div>
                        <div id="ldapMappingsList" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="button" class="raised" id="btnTestLdap">
                            <span>Test LDAP Connection</span>
                        </button>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="button" class="raised button-submit block emby-button" id="btnSaveLdapSettings">
                            <span>Save LDAP Settings</span>
                        </button>
                </div>
            </div>

            <!-- Settings Tab -->
                <div id="settingsTab" class="tabContent" style="display: none;">
                    <form id="settingsForm">
                        <div class="verticalSection">
                            <h3 class="sectionTitle">Sync Settings</h3>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncDisplayLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Display Language</span>
                        </label>
                                <div class="fieldDescription">Update user's Jellyfin UI language when their plugin language changes.</div>
                    </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncSubtitleLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Subtitle Language</span>
                        </label>
                                <div class="fieldDescription">Update user's preferred subtitle language.</div>
                    </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncAudioLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Audio Language</span>
                        </label>
                                <div class="fieldDescription">Update user's preferred audio language.</div>
                </div>

                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="mirrorSyncInterval">Mirror Sync Interval (hours)</label>
                                <input id="mirrorSyncInterval" type="number" is="emby-input" min="1" value="6" />
                                <div class="fieldDescription">How often to sync mirror libraries with source libraries.</div>
                            </div>
                        </div>

                        <div class="verticalSection">
                            <button type="button" is="emby-collapse" class="emby-collapse" title="Advanced Settings">
                                <span class="collapseTitle">Advanced Settings</span>
                            </button>
                            <div class="collapseContent" style="display: none;">
                                <div class="verticalSection" style="margin-top: 1em;">
                                    <h3 class="sectionTitle">File Exclusions</h3>
                                    <p class="fieldDescription" style="margin-bottom: 1em;">
                                        Customize which files and directories are excluded from mirroring. 
                                        Excluded files will not be hardlinked - typically metadata and images that should be language-specific.
                                    </p>
                                    
                                    <div class="inputContainer" style="margin-bottom: 1.5em;">
                                        <label class="inputLabel inputLabelUnfocused" for="excludedExtensions" style="display: block; margin-bottom: 0.5em;">Excluded File Extensions</label>
                                        <textarea id="excludedExtensions" is="emby-textarea" rows="6" style="font-family: monospace; width: 100%; box-sizing: border-box;"></textarea>
                                        <div class="fieldDescription">File extensions to exclude from hardlinking (one per line, include the dot). Default: .nfo, .jpg, .jpeg, .png, .gif, .webp, .tbn, .bmp</div>
                                    </div>
                                    
                                    <div class="inputContainer" style="margin-bottom: 1.5em;">
                                        <label class="inputLabel inputLabelUnfocused" for="excludedDirectories" style="display: block; margin-bottom: 0.5em;">Excluded Directory Names</label>
                                        <textarea id="excludedDirectories" is="emby-textarea" rows="6" style="font-family: monospace; width: 100%; box-sizing: border-box;"></textarea>
                                        <div class="fieldDescription">Directory names to exclude from mirroring (one per line). Default: extrafanart, extrathumbs, .trickplay, metadata, .actors</div>
                                    </div>
                                    
                                    <button is="emby-button" type="button" class="raised" id="btnResetExclusions">
                                        <span>Reset to Defaults</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="verticalSection">
                            <h3 class="sectionTitle">Maintenance</h3>
                            <p class="fieldDescription" style="margin-bottom: 1em;">
                                If you delete a source library or a mirror library manually, the plugin will detect this automatically.
                                You can also manually cleanup orphaned mirrors using the button below.
                            </p>
                            <button is="emby-button" type="button" class="raised" id="btnCleanupMirrors">
                                <span>Cleanup Orphaned Mirrors</span>
                            </button>
                            <div id="cleanupResult" class="fieldDescription" style="margin-top: 0.5em; display: none;"></div>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save Settings</span>
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <!-- Add Alternative Dialog -->
        <div id="addAlternativeDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Language Alternative</h3>
                <form id="addAlternativeForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="altName">Name</label>
                        <input id="altName" type="text" is="emby-input" required />
                        <div class="fieldDescription">Display name (e.g., "Portuguese")</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="altLanguage">Language</label>
                        <select id="altLanguage" is="emby-select" required></select>
                        <div class="fieldDescription">Select the language for metadata</div>
                    </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="altCountry">Country</label>
                        <select id="altCountry" is="emby-select"></select>
                        <div class="fieldDescription">Select the country for region-specific metadata</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="altDestinationPath">Destination Base Path</label>
                        <div style="display: flex; align-items: center;">
                            <input id="altDestinationPath" type="text" is="emby-input" required placeholder="/media/portuguese" style="flex-grow: 1;" />
                            <button type="button" is="paper-icon-button-light" class="btnBrowseDestination" title="Browse" style="margin-left: 0.5em;">
                                <span class="material-icons folder_open" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div class="fieldDescription">Base path for mirror directories (must be on same filesystem as source)</div>
                    </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addAlternativeDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Mirror Dialog -->
        <div id="addMirrorDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Library Mirror</h3>
                <form id="addMirrorForm">
                    <input type="hidden" id="mirrorAlternativeId" />
                    <div class="selectContainer">
                        <label class="selectLabel" for="mirrorSourceLibrary">Source Library</label>
                        <select id="mirrorSourceLibrary" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetPath">Target Path</label>
                        <div style="display: flex; align-items: center;">
                            <input id="mirrorTargetPath" type="text" is="emby-input" required style="flex-grow: 1;" />
                            <button type="button" is="paper-icon-button-light" class="btnBrowseMirrorPath" title="Browse" style="margin-left: 0.5em;">
                                <span class="material-icons folder_open" aria-hidden="true"></span>
                            </button>
                </div>
                        <div class="fieldDescription">Path where mirrored files will be created (auto-suggested, must be on same filesystem as source)</div>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetName">Library Name (optional)</label>
                        <input id="mirrorTargetName" type="text" is="emby-input" placeholder="Movies (Portuguese)" />
                        <div class="fieldDescription">Name for the new Jellyfin library</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addMirrorDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mirror</button>
                </div>
                </form>
            </div>
        </div>

        <!-- Add LDAP Mapping Dialog -->
        <div id="addLdapMappingDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add LDAP Group Mapping</h3>
                <form id="addLdapMappingForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupDn">Group DN</label>
                        <input id="ldapGroupDn" type="text" is="emby-input" required placeholder="CN=Portuguese Users,OU=Groups,DC=example,DC=com" />
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupName">Group Name (optional)</label>
                        <input id="ldapGroupName" type="text" is="emby-input" placeholder="Portuguese Users" />
                        <div class="fieldDescription">Friendly name, also used for CN matching</div>
                </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="ldapLanguageAlt">Language Alternative</label>
                        <select id="ldapLanguageAlt" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapPriority">Priority</label>
                        <input id="ldapPriority" type="number" is="emby-input" value="0" />
                        <div class="fieldDescription">Higher priority wins when user is in multiple groups</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="PolyglotConfig.closeDialog('addLdapMappingDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mapping</button>
                </div>
                </form>
        </div>
    </div>

        <script type="text/javascript">
            var PolyglotConfig = {
                pluginUniqueId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                alternatives: [],
                libraries: [],
                users: [],
                cultures: [],
                countries: [],
                serverConfig: null,
                initialized: false,

                // Custom API helpers for plugin-specific endpoints
                apiGet: function(endpoint) {
                    return ApiClient.getJSON(ApiClient.getUrl(endpoint));
                },

                apiPost: function(endpoint, data) {
                    return ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
            });
                },

                apiPut: function(endpoint, data) {
                    return ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'PUT',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
                    });
                },

                apiDelete: function(endpoint) {
                    return ApiClient.fetch({
                        url: ApiClient.getUrl(endpoint),
                        type: 'DELETE'
                    });
                },

                // Tab switching
                switchTab: function(tabId) {
                    document.querySelectorAll('.tabContent').forEach(function(tab) {
                        tab.style.display = 'none';
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    document.getElementById(tabId).style.display = 'block';
                    document.getElementById(tabId).classList.add('active');
                    document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
                },

                // Dialog helpers
                showDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'flex';
                    dialog.classList.remove('hide');
                },

                closeDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'none';
                    dialog.classList.add('hide');
                    // Reset form if present
                    var form = dialog.querySelector('form');
                    if (form) {
                        form.reset();
                    }
                },

                browseForPath: function(inputId) {
                    var input = document.getElementById(inputId);
                    var currentPath = input.value || '';
                    
                    var picker = new Dashboard.DirectoryBrowser();
                    picker.show({
                        includeDirectories: true,
                        includeFiles: false,
                        path: currentPath,
                        header: 'Select Destination Folder',
                        callback: function(path) {
                            if (path) {
                                input.value = path;
                            }
                            picker.close();
                        }
                    });
                },

        // Load data
                loadServerConfig: function() {
                    var self = this;
                    return ApiClient.getServerConfiguration().then(function(config) {
                        self.serverConfig = config;
                        return config;
                    });
                },

                loadCultures: function() {
                    var self = this;
                    return ApiClient.getCultures().then(function(cultures) {
                        self.cultures = cultures.sort(function(a, b) {
                            return a.DisplayName.localeCompare(b.DisplayName);
                        });
                        return cultures;
                    });
                },

                loadCountries: function() {
                    var self = this;
                    return ApiClient.getCountries().then(function(countries) {
                        self.countries = countries.sort(function(a, b) {
                            return a.DisplayName.localeCompare(b.DisplayName);
                        });
                        return countries;
                    });
                },

                getLanguageDisplayName: function(code) {
                    if (!code) {
                        // Use server default if no code specified
                        if (this.serverConfig && this.serverConfig.PreferredMetadataLanguage) {
                            code = this.serverConfig.PreferredMetadataLanguage;
                        } else {
                            return 'default';
                        }
                    }
                    // Try to find the culture name
                    var culture = this.cultures.find(function(c) {
                        return c.TwoLetterISOLanguageName === code || 
                               c.ThreeLetterISOLanguageName === code ||
                               c.DisplayName.toLowerCase() === code.toLowerCase();
                    });
                    return culture ? culture.DisplayName : code;
                },

                loadLibraries: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    // Use built-in ApiClient method for libraries, enhanced with our plugin data
                    Promise.all([
                        ApiClient.getVirtualFolders(),
                        ApiClient.getPluginConfiguration(this.pluginUniqueId)
                    ]).then(function(results) {
                        var folders = results[0];
                        var config = results[1];
                        
                        // Build set of mirror library IDs
                        var mirrorIds = new Set();
                        if (config.LanguageAlternatives) {
                            config.LanguageAlternatives.forEach(function(alt) {
                                if (alt.MirroredLibraries) {
                                    alt.MirroredLibraries.forEach(function(m) {
                                        if (m.TargetLibraryId) mirrorIds.add(m.TargetLibraryId);
                                    });
                                }
                            });
                        }
                        
                        self.libraries = folders.map(function(folder) {
                            // Convert Jellyfin's ItemId to proper GUID format with dashes
                            var itemId = folder.ItemId;
                            var guidId = itemId.length === 32 
                                ? itemId.substring(0,8) + '-' + itemId.substring(8,12) + '-' + itemId.substring(12,16) + '-' + itemId.substring(16,20) + '-' + itemId.substring(20)
                                : itemId;
                            return {
                                Id: guidId,
                                Name: folder.Name,
                                CollectionType: folder.CollectionType,
                                PreferredMetadataLanguage: folder.LibraryOptions ? folder.LibraryOptions.PreferredMetadataLanguage : null,
                                IsMirror: mirrorIds.has(folder.ItemId) || mirrorIds.has(guidId)
                            };
                        });
                        
                        var html = '';
                        self.libraries.forEach(function(lib) {
                            var langDisplay = self.getLanguageDisplayName(lib.PreferredMetadataLanguage);
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody">';
                            html += '<div class="listItemBodyText">' + lib.Name + '</div>';
                            html += '<div class="listItemBodyText secondary">' + (lib.CollectionType || 'mixed') + ' • ' + langDisplay + '</div>';
                            html += '</div>';
                            if (lib.IsMirror) {
                                html += '<span class="material-icons" style="color: #00a4dc;">content_copy</span>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('librariesList').innerHTML = html || '<p class="fieldDescription">No libraries found.</p>';
                        Dashboard.hideLoadingMsg();
                    });
                },

                loadAlternatives: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        self.alternatives = config.LanguageAlternatives || [];
                        var html = '';
                        self.alternatives.forEach(function(alt) {
                            html += '<div class="listItem" style="flex-wrap: wrap;">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            var langDisplay = self.getLanguageDisplayName(alt.MetadataLanguage);
                            var countryDisplay = alt.MetadataCountry || '';
                            var metadataInfo = langDisplay + (countryDisplay ? ' (' + countryDisplay + ')' : '');
                            html += '<div class="listItemBodyText">' + alt.Name + '</div>';
                            html += '<div class="listItemBodyText secondary">Metadata: ' + metadataInfo + ' • Path: ' + (alt.DestinationBasePath || 'not set') + '</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.showAddMirrorDialog(\'' + alt.Id + '\')"><span class="material-icons add"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.syncAlternative(\'' + alt.Id + '\')"><span class="material-icons sync"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteAlternative(\'' + alt.Id + '\')"><span class="material-icons delete"></span></button>';
                            
                            // Show mirrors
                            if (alt.MirroredLibraries && alt.MirroredLibraries.length > 0) {
                                html += '<div style="width: 100%; padding-left: 1em; margin-top: 0.5em;">';
                                alt.MirroredLibraries.forEach(function(mirror) {
                                    html += '<div class="listItem" style="background: rgba(0,0,0,0.2);">';
                                    html += '<span class="material-icons">subdirectory_arrow_right</span>';
                                    html += '<div class="listItemBody" style="flex: 1;">';
                                    html += '<div class="listItemBodyText">' + mirror.SourceLibraryName + ' → ' + mirror.TargetLibraryName + '</div>';
                                    html += '<div class="listItemBodyText secondary">' + mirror.Status + (mirror.LastSyncedAt ? ' • Last sync: ' + new Date(mirror.LastSyncedAt).toLocaleString() : '') + '</div>';
                                    html += '</div>';
                                    html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteMirror(\'' + alt.Id + '\', \'' + mirror.SourceLibraryId + '\')"><span class="material-icons delete"></span></button>';
                                    html += '</div>';
                                });
                                html += '</div>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('alternativesList').innerHTML = html || '<p class="fieldDescription">No language alternatives configured. Click + to add one.</p>';
                    });
                },

                loadUsers: function() {
                    var self = this;
                    // Use built-in ApiClient.getUsers() and merge with plugin config
                    Promise.all([
                        ApiClient.getUsers(),
                        ApiClient.getPluginConfiguration(this.pluginUniqueId)
                    ]).then(function(results) {
                        var jellyfinUsers = results[0];
                        var config = results[1];
                        // Convert UserLanguages array to a lookup object by UserId
                        var userLanguagesArray = config.UserLanguages || [];
                        var userLanguages = {};
                        userLanguagesArray.forEach(function(ul) {
                            userLanguages[ul.UserId] = ul;
                        });
                        
                        self.users = jellyfinUsers.map(function(user) {
                            var langConfig = userLanguages[user.Id];
                            var altName = null;
                            var isManaged = langConfig ? langConfig.IsPluginManaged : false;
                            if (langConfig && langConfig.SelectedAlternativeId) {
                                var alt = self.alternatives.find(function(a) { return a.Id === langConfig.SelectedAlternativeId; });
                                if (alt) altName = alt.Name;
                            }
                            return {
                                Id: user.Id,
                                Username: user.Name,
                                IsAdministrator: user.Policy && user.Policy.IsAdministrator,
                                IsPluginManaged: isManaged,
                                AssignedAlternativeId: langConfig ? langConfig.SelectedAlternativeId : null,
                                AssignedAlternativeName: altName,
                                ManuallySet: langConfig ? langConfig.ManuallySet : false
                            };
                        });
                        
                        var html = '';
                        self.users.forEach(function(user) {
                            // Determine status text
                            var statusText = 'Not managed by plugin';
                            if (user.IsPluginManaged) {
                                statusText = user.AssignedAlternativeName || 'Default libraries';
                                if (user.ManuallySet) statusText += ' (manual)';
                            }
                            
                            // Determine current selection value
                            var currentValue = 'disabled';
                            if (user.IsPluginManaged) {
                                currentValue = user.AssignedAlternativeId || 'default';
                            }
                            
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + user.Username + (user.IsAdministrator ? ' (Admin)' : '') + '</div>';
                            html += '<div class="listItemBodyText secondary">' + statusText + '</div>';
                            html += '</div>';
                            html += '<select is="emby-select" onchange="PolyglotConfig.setUserLanguage(\'' + user.Id + '\', this.value)" style="width: auto;">';
                            html += '<option value="disabled"' + (currentValue === 'disabled' ? ' selected' : '') + '>Not managed</option>';
                            html += '<option value="default"' + (currentValue === 'default' ? ' selected' : '') + '>Default libraries</option>';
                            self.alternatives.forEach(function(alt) {
                                html += '<option value="' + alt.Id + '"' + (currentValue === alt.Id ? ' selected' : '') + '>' + alt.Name + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';
                        });
                        document.getElementById('usersList').innerHTML = html || '<p class="fieldDescription">No users found.</p>';
                    });
                },

                loadLdapStatus: function() {
                    var self = this;
                    this.apiGet('Polyglot/LdapStatus').then(function(status) {
                        // Only show LDAP tab if plugin is installed
                        var ldapTabButton = document.getElementById('ldapTabButton');
                        if (status.IsPluginInstalled) {
                            ldapTabButton.style.display = '';
                            
                            var html = '<div class="listItem"><div class="listItemBody">';
                            html += '<div class="listItemBodyText">LDAP Plugin: ✓ Installed</div>';
                            html += '<div class="listItemBodyText secondary">';
                            html += 'Configured: ' + (status.IsConfigured ? '✓' : '✗');
                            html += ' • Integration: ' + (status.IsIntegrationEnabled ? '✓ Enabled' : '✗ Disabled');
                            if (status.ServerAddress) html += ' • Server: ' + status.ServerAddress;
                            html += '</div>';
                            html += '</div></div>';
                            document.getElementById('ldapStatus').innerHTML = html;
                            
                            // Load the checkbox value
                            document.getElementById('enableLdapIntegration').checked = status.IsIntegrationEnabled;
                            
                            // Load mappings only if installed
                            self.loadLdapMappings();
                        } else {
                            ldapTabButton.style.display = 'none';
                        }
                    });
                },

                loadLdapMappings: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        var mappings = config.LdapGroupMappings || [];
                        var html = '';
                        mappings.forEach(function(mapping) {
                            var altName = 'Unknown';
                            self.alternatives.forEach(function(alt) {
                                if (alt.Id === mapping.LanguageAlternativeId) altName = alt.Name;
                            });
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + (mapping.LdapGroupName || mapping.LdapGroupDn) + '</div>';
                            html += '<div class="listItemBodyText secondary">→ ' + altName + ' (Priority: ' + mapping.Priority + ')</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="PolyglotConfig.deleteLdapMapping(\'' + mapping.Id + '\')"><span class="material-icons delete"></span></button>';
                            html += '</div>';
                        });
                        document.getElementById('ldapMappingsList').innerHTML = html || '<p class="fieldDescription">No LDAP group mappings configured.</p>';
                    });
                },

                // Default exclusion values (matching the C# defaults)
                defaultExcludedExtensions: ['.nfo', '.jpg', '.jpeg', '.png', '.gif', '.webp', '.tbn', '.bmp'],
                defaultExcludedDirectories: ['extrafanart', 'extrathumbs', '.trickplay', 'metadata', '.actors'],

                loadSettings: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        document.getElementById('syncDisplayLanguage').checked = config.SyncUserDisplayLanguage;
                        document.getElementById('syncSubtitleLanguage').checked = config.SyncUserSubtitleLanguage;
                        document.getElementById('syncAudioLanguage').checked = config.SyncUserAudioLanguage;
                        document.getElementById('mirrorSyncInterval').value = config.MirrorSyncIntervalHours || 6;
                        
                        // Load exclusion settings
                        var extensions = config.ExcludedExtensions || self.defaultExcludedExtensions;
                        var directories = config.ExcludedDirectories || self.defaultExcludedDirectories;
                        document.getElementById('excludedExtensions').value = extensions.join('\n');
                        document.getElementById('excludedDirectories').value = directories.join('\n');
                    });
                },
                
                resetExclusionsToDefaults: function() {
                    document.getElementById('excludedExtensions').value = this.defaultExcludedExtensions.join('\n');
                    document.getElementById('excludedDirectories').value = this.defaultExcludedDirectories.join('\n');
                    Dashboard.alert('Exclusion settings reset to defaults. Click "Save Settings" to apply.');
                },

        // Actions
                showAddMirrorDialog: function(altId) {
                    var self = this;
                    var alternative = this.alternatives.find(function(a) { return a.Id === altId; });
                    document.getElementById('mirrorAlternativeId').value = altId;
                    
                    // Get IDs of libraries that already have mirrors in this alternative
                    var alreadyMirroredIds = new Set();
                    if (alternative && alternative.MirroredLibraries) {
                        alternative.MirroredLibraries.forEach(function(m) {
                            alreadyMirroredIds.add(m.SourceLibraryId);
                        });
                    }
                    
                    var select = document.getElementById('mirrorSourceLibrary');
                    select.innerHTML = '';
                    
                    // Filter: not a mirror AND not already mirrored for this alternative
                    var availableLibs = this.libraries.filter(function(lib) { 
                        return !lib.IsMirror && !alreadyMirroredIds.has(lib.Id); 
                    });
                    
                    if (availableLibs.length === 0) {
                        select.innerHTML = '<option value="" disabled>No available libraries</option>';
                        Dashboard.alert('All source libraries already have mirrors for this language alternative.');
                        return;
                    }
                    
                    availableLibs.forEach(function(lib) {
                        select.innerHTML += '<option value="' + lib.Id + '">' + lib.Name + '</option>';
                    });
                    
                    // Auto-suggest target path based on base path + library name
                    this.updateMirrorTargetPath(alternative, availableLibs[0]);
                    
                    // Update path when library selection changes
                    select.onchange = function() {
                        var selectedLib = availableLibs.find(function(lib) { return lib.Id === select.value; });
                        self.updateMirrorTargetPath(alternative, selectedLib);
                    };
                    
                    this.showDialog('addMirrorDialog');
                },
                
                updateMirrorTargetPath: function(alternative, library) {
                    if (!alternative || !library) return;
                    
                    var basePath = alternative.DestinationBasePath || '';
                    var libName = library.Name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    
                    // Remove trailing slash from base path
                    if (basePath.endsWith('/')) {
                        basePath = basePath.slice(0, -1);
                    }
                    
                    var suggestedPath = basePath + '/' + libName;
                    document.getElementById('mirrorTargetPath').value = suggestedPath;
                    
                    // Also suggest library name
                    var targetNameInput = document.getElementById('mirrorTargetName');
                    if (!targetNameInput.value) {
                        targetNameInput.placeholder = library.Name + ' (' + alternative.Name + ')';
                    }
                },

                createAlternative: function() {
                    var self = this;
                    var languageSelect = document.getElementById('altLanguage');
                    var countrySelect = document.getElementById('altCountry');
                    var selectedCulture = this.cultures.find(function(c) { 
                        return c.TwoLetterISOLanguageName === languageSelect.value; 
                    });
                    var selectedCountry = this.countries.find(function(c) { 
                        return c.TwoLetterISORegionName === countrySelect.value; 
                    });
                    
                    // Build language code like "pt-BR" from selections
                    var languageCode = languageSelect.value;
                    if (countrySelect.value) {
                        languageCode += '-' + countrySelect.value;
                    }
                    
                    var data = {
                        Name: document.getElementById('altName').value,
                        LanguageCode: languageCode,
                        MetadataLanguage: languageSelect.value || null,
                        MetadataCountry: countrySelect.value || null,
                        DestinationBasePath: document.getElementById('altDestinationPath').value
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives', data).then(function() {
                        self.closeDialog('addAlternativeDialog');
                        // Reload alternatives first, then users (which depends on alternatives for dropdown)
                        self.loadAlternatives();
                        self.loadUsers();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create alternative: ' + e.message);
                    });
                },

                createMirror: function() {
                    var self = this;
                    var altId = document.getElementById('mirrorAlternativeId').value;
                    var alternative = this.alternatives.find(function(a) { return a.Id === altId; });
                    var sourceLibId = document.getElementById('mirrorSourceLibrary').value;
                    var sourceLib = this.libraries.find(function(l) { return l.Id === sourceLibId; });
                    
                    // Use entered name, or auto-generate from source library + alternative
                    var targetName = document.getElementById('mirrorTargetName').value;
                    if (!targetName && sourceLib && alternative) {
                        targetName = sourceLib.Name + ' (' + alternative.Name + ')';
                    }
                    
                    var data = {
                        SourceLibraryId: sourceLibId,
                        TargetPath: document.getElementById('mirrorTargetPath').value,
                        TargetLibraryName: targetName
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives/' + altId + '/Libraries', data).then(function() {
                        self.closeDialog('addMirrorDialog');
                        self.loadAlternatives();
                        self.loadLibraries();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create mirror: ' + e.message);
                    });
                },

                syncAlternative: function(altId) {
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/Alternatives/' + altId + '/Sync', {}).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Sync started. Check the scheduled tasks for progress.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to start sync: ' + e.message);
                    });
                },

                deleteAlternative: function(altId) {
                    var self = this;
                    Dashboard.confirm('Delete this language alternative and all its mirrors?', 'Confirm Delete', function(result) {
                        if (result) {
                            Dashboard.showLoadingMsg();
                            self.apiDelete('Polyglot/Alternatives/' + altId + '?deleteLibraries=true&deleteFiles=true').then(function() {
                                self.loadAlternatives();
                                self.loadLibraries();
                                self.loadUsers();
                                Dashboard.hideLoadingMsg();
                            });
                        }
                    });
                },

                deleteMirror: function(altId, sourceLibraryId) {
                    var self = this;
                    Dashboard.confirm('Delete this mirror library? This will remove the Jellyfin library and its hardlinked files.', 'Confirm Delete', function(result) {
                        if (result) {
                            Dashboard.showLoadingMsg();
                            self.apiDelete('Polyglot/Alternatives/' + altId + '/Libraries/' + sourceLibraryId + '?deleteLibrary=true&deleteFiles=true').then(function() {
                                self.loadAlternatives();
                                self.loadLibraries();
                                Dashboard.hideLoadingMsg();
                            }).catch(function(e) {
                                Dashboard.hideLoadingMsg();
                                Dashboard.alert('Failed to delete mirror: ' + e.message);
                            });
                        }
                    });
                },

                setUserLanguage: function(userId, value) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    
                    var requestData = {
                        ManuallySet: true
                    };
                    
                    if (value === 'disabled') {
                        // User is not managed by plugin
                        requestData.IsDisabled = true;
                    } else if (value === 'default') {
                        // Managed, but no specific language (default libraries)
                        requestData.AlternativeId = null;
                        requestData.IsDisabled = false;
                    } else {
                        // Managed with a specific language
                        requestData.AlternativeId = value;
                        requestData.IsDisabled = false;
                    }
                    
                    this.apiPut('Polyglot/Users/' + userId + '/Language', requestData).then(function() {
                        self.loadUsers();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to set user language: ' + e.message);
                    });
                },

                createLdapMapping: function() {
                    var self = this;
                    var data = {
                        LdapGroupDn: document.getElementById('ldapGroupDn').value,
                        LdapGroupName: document.getElementById('ldapGroupName').value || null,
                        LanguageAlternativeId: document.getElementById('ldapLanguageAlt').value,
                        Priority: parseInt(document.getElementById('ldapPriority').value) || 0
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('Polyglot/LdapGroups', data).then(function() {
                        self.closeDialog('addLdapMappingDialog');
                        self.loadLdapMappings();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create LDAP mapping: ' + e.message);
                    });
                },

                deleteLdapMapping: function(id) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    this.apiDelete('Polyglot/LdapGroups/' + id).then(function() {
                        self.loadLdapMappings();
                        Dashboard.hideLoadingMsg();
                    });
                },

                testLdapConnection: function() {
                    var username = prompt('Enter username to test (optional):');
                    Dashboard.showLoadingMsg();
                    var url = 'Polyglot/TestLdap';
                    if (username) {
                        url += '?username=' + encodeURIComponent(username);
                    }
                    this.apiPost(url, {}).then(function(result) {
                        Dashboard.hideLoadingMsg();
                        var msg = result.Message;
                        if (result.UserGroups && result.UserGroups.length > 0) {
                            msg += '\n\nGroups: ' + result.UserGroups.join(', ');
                        }
                        if (result.MatchedLanguage) {
                            msg += '\n\nMatched Language: ' + result.MatchedLanguage;
                        }
                        Dashboard.alert(msg);
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('LDAP test failed: ' + e.message);
                    });
                },

                enableAllUsers: function() {
                    var self = this;
                    Dashboard.confirm(
                        'This will enable plugin management for ALL users, setting them to "Default libraries". ' +
                        'Each user\'s EnableAllFolders will be set to false. Continue?',
                        'Enable Plugin for All Users',
                        function(result) {
                            if (result) {
                                Dashboard.showLoadingMsg();
                                self.apiPost('Polyglot/Users/EnableAll', {}).then(function(response) {
                                    Dashboard.hideLoadingMsg();
                                    Dashboard.alert('Enabled plugin for ' + response.UsersEnabled + ' users.');
                                    self.loadUsers();
                                }).catch(function(e) {
                                    Dashboard.hideLoadingMsg();
                                    Dashboard.alert('Failed to enable users: ' + e.message);
                                });
                            }
                        }
                    );
                },

                cleanupOrphanedMirrors: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    var resultDiv = document.getElementById('cleanupResult');
                    resultDiv.style.display = 'none';
                    
                    this.apiPost('Polyglot/CleanupOrphanedMirrors', {}).then(function(response) {
                        Dashboard.hideLoadingMsg();
                        resultDiv.style.display = 'block';
                        if (response.TotalCleaned === 0) {
                            resultDiv.textContent = 'No orphaned mirrors found.';
                            resultDiv.style.color = '#52b54b';
                        } else {
                            resultDiv.innerHTML = '<strong>Cleaned up ' + response.TotalCleaned + ' mirrors:</strong><br/>' + 
                                response.CleanedUpMirrors.join('<br/>');
                            resultDiv.style.color = '#f2b01e';
                            // Reload the alternatives list
                            self.loadAlternatives();
                        }
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        resultDiv.style.display = 'block';
                        resultDiv.textContent = 'Failed to cleanup: ' + e.message;
                        resultDiv.style.color = '#cc3333';
                    });
                },

                saveSettings: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        // Update only the settings fields
                        config.SyncUserDisplayLanguage = document.getElementById('syncDisplayLanguage').checked;
                        config.SyncUserSubtitleLanguage = document.getElementById('syncSubtitleLanguage').checked;
                        config.SyncUserAudioLanguage = document.getElementById('syncAudioLanguage').checked;
                        config.MirrorSyncIntervalHours = parseInt(document.getElementById('mirrorSyncInterval').value) || 6;
                        
                        // Parse exclusion settings (split by newlines, filter empty, trim whitespace)
                        var extensionsText = document.getElementById('excludedExtensions').value;
                        var directoriesText = document.getElementById('excludedDirectories').value;
                        
                        config.ExcludedExtensions = extensionsText.split('\n')
                            .map(function(s) { return s.trim(); })
                            .filter(function(s) { return s.length > 0; });
                        
                        config.ExcludedDirectories = directoriesText.split('\n')
                            .map(function(s) { return s.trim(); })
                            .filter(function(s) { return s.length > 0; });
                        
                        return ApiClient.updatePluginConfiguration(self.pluginUniqueId, config);
                    }).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.processPluginConfigurationUpdateResult();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save settings: ' + e.message);
                    });
                },

                saveLdapSettings: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        config.EnableLdapIntegration = document.getElementById('enableLdapIntegration').checked;
                        return ApiClient.updatePluginConfiguration(self.pluginUniqueId, config);
                    }).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.processPluginConfigurationUpdateResult();
                        self.loadLdapStatus();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save LDAP settings: ' + e.message);
                    });
                },

                populateLanguageDropdowns: function() {
                    var self = this;
                    var langSelect = document.getElementById('altLanguage');
                    var countrySelect = document.getElementById('altCountry');
                    
                    // Populate language dropdown
                    langSelect.innerHTML = '<option value="">-- Select Language --</option>';
                    this.cultures.forEach(function(culture) {
                        langSelect.innerHTML += '<option value="' + culture.TwoLetterISOLanguageName + '">' + 
                            culture.DisplayName + ' (' + culture.TwoLetterISOLanguageName + ')</option>';
                    });
                    
                    // Populate country dropdown
                    countrySelect.innerHTML = '<option value="">-- None (Optional) --</option>';
                    this.countries.forEach(function(country) {
                        countrySelect.innerHTML += '<option value="' + country.TwoLetterISORegionName + '">' + 
                            country.DisplayName + ' (' + country.TwoLetterISORegionName + ')</option>';
                    });
                    
                    // Auto-fill name when language changes
                    langSelect.addEventListener('change', function() {
                        var nameInput = document.getElementById('altName');
                        if (!nameInput.value) {
                            var culture = self.cultures.find(function(c) { 
                                return c.TwoLetterISOLanguageName === langSelect.value; 
                            });
                            if (culture) {
                                nameInput.value = culture.DisplayName;
                            }
                        }
                    });
                },

                init: function() {
                    var self = this;
                    
                    // Load reference data first, then other data
                    Promise.all([
                        this.loadServerConfig(),
                        this.loadCultures(),
                        this.loadCountries()
                    ]).then(function() {
                        // Now load the rest
                        self.loadLibraries();
                        self.loadAlternatives();
                        self.loadUsers();
                        self.loadLdapStatus();
                        self.loadSettings();
                        
                        // Populate dropdowns
                        self.populateLanguageDropdowns();
                    });

                    // Only attach event listeners once
                    if (this.initialized) {
                        return;
                    }
                    this.initialized = true;

                    // Tab buttons
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            self.switchTab(this.getAttribute('data-tab'));
                        });
                    });

                    // Add alternative button
                    document.getElementById('btnAddAlternative').addEventListener('click', function() {
                        self.showDialog('addAlternativeDialog');
                    });

                    // Browse destination path buttons
                    document.querySelector('.btnBrowseDestination').addEventListener('click', function() {
                        self.browseForPath('altDestinationPath');
                    });
                    
                    document.querySelector('.btnBrowseMirrorPath').addEventListener('click', function() {
                        self.browseForPath('mirrorTargetPath');
                    });

                    // Add LDAP mapping button
                    document.getElementById('btnAddLdapMapping').addEventListener('click', function() {
                        var select = document.getElementById('ldapLanguageAlt');
                        select.innerHTML = '';
                        self.alternatives.forEach(function(alt) {
                            select.innerHTML += '<option value="' + alt.Id + '">' + alt.Name + '</option>';
                        });
                        self.showDialog('addLdapMappingDialog');
                    });

                    // Enable all users button
                    document.getElementById('btnEnableAllUsers').addEventListener('click', function() {
                        self.enableAllUsers();
                    });

                    // Cleanup orphaned mirrors button
                    document.getElementById('btnCleanupMirrors').addEventListener('click', function() {
                        self.cleanupOrphanedMirrors();
                    });

                    // Reset exclusions button
                    document.getElementById('btnResetExclusions').addEventListener('click', function() {
                        self.resetExclusionsToDefaults();
                    });

                    // Advanced settings collapse toggle
                    document.querySelectorAll('.emby-collapse').forEach(function(collapseBtn) {
                        collapseBtn.addEventListener('click', function() {
                            var content = this.nextElementSibling;
                            var isExpanded = content.style.display !== 'none';
                            content.style.display = isExpanded ? 'none' : 'block';
                            this.classList.toggle('expanded', !isExpanded);
                        });
                    });

                    // Test LDAP button
                    document.getElementById('btnTestLdap').addEventListener('click', function() {
                        self.testLdapConnection();
                    });

                    // Save LDAP settings button
                    document.getElementById('btnSaveLdapSettings').addEventListener('click', function() {
                        self.saveLdapSettings();
                    });

                    // Form submissions
                    document.getElementById('addAlternativeForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createAlternative();
                    });

                    document.getElementById('addMirrorForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createMirror();
                    });

                    document.getElementById('addLdapMappingForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createLdapMapping();
                    });

                    document.getElementById('settingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.saveSettings();
                    });
                }
            };

            document.getElementById('polyglotConfigPage').addEventListener('pageshow', function() {
                PolyglotConfig.init();
        });
    </script>

        <style type="text/css">
            .dialog {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }
            .dialog.hide {
                display: none !important;
            }
            .dialogContent {
                background: #1a1a1a;
                padding: 2em;
                border-radius: 8px;
                min-width: 400px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
            }
            .formDialogFooter {
                display: flex;
                justify-content: flex-end;
                gap: 1em;
                margin-top: 1.5em;
            }
            .tabContent {
                min-height: 200px;
            }
            .emby-tab-button.active {
                border-bottom: 3px solid #00a4dc;
                color: #00a4dc;
                font-weight: 600;
            }
            .emby-tab-button {
                border-bottom: 3px solid transparent;
                transition: border-color 0.2s ease, color 0.2s ease;
            }
            .emby-collapse {
                display: flex;
                align-items: center;
                width: 100%;
                padding: 0.8em 1em;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 4px;
                cursor: pointer;
                text-align: left;
                font-size: 1em;
                color: inherit;
                transition: background 0.2s ease;
            }
            .emby-collapse:hover {
                background: rgba(255,255,255,0.08);
            }
            .emby-collapse::before {
                content: '';
                display: inline-block;
                width: 0;
                height: 0;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 6px solid currentColor;
                margin-right: 0.8em;
                transform: rotate(-90deg);
                transition: transform 0.2s ease;
            }
            .emby-collapse.expanded::before {
                transform: rotate(0deg);
            }
            .collapseTitle {
                font-weight: 500;
            }
            .collapseContent {
                border-left: 2px solid rgba(0,164,220,0.3);
                margin-left: 0.5em;
                margin-top: 1em;
                padding: 1em 1.5em 1.5em 1.5em;
            }
            .collapseContent textarea {
                min-height: 120px;
                resize: vertical;
            }
        </style>
    </div>
</body>
</html>
