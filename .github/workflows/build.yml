name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Extract version from tag (v0.0.5 -> 0.0.5.0)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          # Ensure 4-part version (add .0 if needed)
          IFS='.' read -ra PARTS <<< "$TAG_VERSION"
          while [ ${#PARTS[@]} -lt 4 ]; do
            PARTS+=("0")
          done
          VERSION="${PARTS[0]}.${PARTS[1]}.${PARTS[2]}.${PARTS[3]}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Update build.yaml with the version from tag
          sed -i "s/^version: .*/version: \"$VERSION\"/" Jellyfin.Plugin.MultiLang/build.yaml
          echo "Updated build.yaml to version $VERSION"
          cat Jellyfin.Plugin.MultiLang/build.yaml

      - name: Build Plugin
        id: jprm
        uses: oddstr13/jellyfin-plugin-repository-manager@v1.1.1
        with:
          dotnet-target: "net8.0"
          path: Jellyfin.Plugin.MultiLang

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ${{ steps.jprm.outputs.artifact }}

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist

      - name: Generate release notes
        id: release_notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Generate release notes using GitHub API
          if [ -n "$PREV_TAG" ]; then
            NOTES=$(gh api repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name="${{ github.ref_name }}" \
              -f previous_tag_name="$PREV_TAG" \
              --jq '.body' 2>/dev/null || echo "Release ${{ github.ref_name }}")
          else
            NOTES="Initial release ${{ github.ref_name }}"
          fi
          
          # Escape for JSON (replace newlines, quotes)
          NOTES_ESCAPED=$(echo "$NOTES" | jq -Rs .)
          echo "RELEASE_NOTES=$NOTES_ESCAPED" >> $GITHUB_ENV

      - name: Generate manifest.json
        run: |
          # Find the zip file
          ZIP_FILE=$(ls dist/*.zip | head -1)
          ZIP_NAME=$(basename "$ZIP_FILE")
          
          # Extract meta.json from the zip
          unzip -p "$ZIP_FILE" meta.json > meta.json
          
          # Calculate MD5 checksum
          CHECKSUM=$(md5sum "$ZIP_FILE" | cut -d' ' -f1)
          
          # Get download URL
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${ZIP_NAME}"
          
          # Generate manifest.json using jq, replacing changelog with release notes
          jq --arg url "$DOWNLOAD_URL" \
             --arg checksum "$CHECKSUM" \
             --argjson changelog "$RELEASE_NOTES" '
            [{
              guid: .guid,
              name: .name,
              overview: .overview,
              description: .description,
              owner: .owner,
              category: .category,
              versions: [{
                version: .version,
                changelog: $changelog,
                targetAbi: .targetAbi,
                sourceUrl: $url,
                checksum: $checksum,
                timestamp: .timestamp
              }]
            }]
          ' meta.json > manifest.json
          
          echo "Generated manifest.json:"
          cat manifest.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.zip
            manifest.json
          generate_release_notes: true
