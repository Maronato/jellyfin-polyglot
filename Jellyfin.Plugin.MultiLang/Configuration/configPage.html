<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Multi-Language Library</title>
    <style>
        .multiLangContainer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1em;
        }

        .tabContainer {
            margin-bottom: 2em;
        }

        .tabButtons {
            display: flex;
            gap: 0.5em;
            border-bottom: 2px solid #333;
            margin-bottom: 1em;
        }

        .tabButton {
            padding: 0.75em 1.5em;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #aaa;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tabButton:hover {
            color: #fff;
        }

        .tabButton.active {
            color: #00a4dc;
            border-bottom-color: #00a4dc;
        }

        .tabContent {
            display: none;
        }

        .tabContent.active {
            display: block;
        }

        .warningBanner {
            background: #5c3d00;
            border: 1px solid #cc7700;
            padding: 1em;
            margin-bottom: 1em;
            border-radius: 4px;
        }

        .warningBanner h4 {
            color: #ffcc00;
            margin: 0 0 0.5em 0;
        }

        .card {
            background: #1a1a1a;
            border-radius: 4px;
            padding: 1em;
            margin-bottom: 1em;
        }

        .card h3 {
            margin-top: 0;
            color: #00a4dc;
        }

        .formGroup {
            margin-bottom: 1em;
        }

        .formGroup label {
            display: block;
            margin-bottom: 0.5em;
            color: #bbb;
        }

        .formGroup input[type="text"],
        .formGroup input[type="number"],
        .formGroup select {
            width: 100%;
            padding: 0.5em;
            background: #333;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
        }

        .formGroup input[type="checkbox"] {
            margin-right: 0.5em;
        }

        .checkboxLabel {
            display: flex;
            align-items: center;
            gap: 0.5em;
            cursor: pointer;
        }

        .buttonRow {
            display: flex;
            gap: 0.5em;
            margin-top: 1em;
        }

        .btn {
            padding: 0.5em 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }

        .btnPrimary {
            background: #00a4dc;
            color: #fff;
        }

        .btnPrimary:hover {
            background: #0088cc;
        }

        .btnSecondary {
            background: #444;
            color: #fff;
        }

        .btnSecondary:hover {
            background: #555;
        }

        .btnDanger {
            background: #cc3333;
            color: #fff;
        }

        .btnDanger:hover {
            background: #aa2222;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75em;
            border-bottom: 1px solid #333;
        }

        th {
            background: #222;
            color: #aaa;
            font-weight: 500;
        }

        .statusBadge {
            display: inline-block;
            padding: 0.25em 0.5em;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .statusPending {
            background: #555;
            color: #aaa;
        }

        .statusSyncing {
            background: #1a4466;
            color: #66aaff;
        }

        .statusSynced {
            background: #1a4422;
            color: #66cc88;
        }

        .statusError {
            background: #441a1a;
            color: #ff6666;
        }

        .ldapStatusOk {
            color: #66cc88;
        }

        .ldapStatusError {
            color: #ff6666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modalContent {
            background: #1a1a1a;
            padding: 2em;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }

        .modalContent h3 {
            margin-top: 0;
            color: #00a4dc;
        }

        .description {
            color: #888;
            font-size: 0.9em;
            margin-top: 0.25em;
        }
    </style>
</head>
<body>
    <div id="multiLangConfigPage" class="multiLangContainer" data-role="page">
        <div class="tabContainer">
            <div class="tabButtons">
                <button class="tabButton active" data-tab="languages">Languages</button>
                <button class="tabButton" data-tab="users">Users</button>
                <button class="tabButton" data-tab="ldap">LDAP</button>
                <button class="tabButton" data-tab="settings">Settings</button>
            </div>

            <!-- Languages Tab -->
            <div id="tabLanguages" class="tabContent active">
                <div class="card">
                    <h3>Jellyfin Libraries</h3>
                    <p class="description">Existing libraries in your Jellyfin server that can be mirrored.</p>
                    <table id="librariesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Metadata Language</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>Language Alternatives</h3>
                    <p class="description">Configure language-specific library mirrors. Each alternative creates hardlinked copies with different metadata languages.</p>
                    <div id="alternativesList"></div>
                    <div class="buttonRow">
                        <button class="btn btnPrimary" onclick="showAddAlternativeModal()">Add Language Alternative</button>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tabUsers" class="tabContent">
                <div class="warningBanner">
                    <h4>⚠️ Watch History Warning</h4>
                    <p>Changing a user's language will change which libraries they can access. Watch history is stored per-library, so users may appear to lose their watch progress when switching languages. Their original history remains in the original library.</p>
                </div>

                <div class="card">
                    <h3>User Language Assignments</h3>
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Assigned Language</th>
                                <th>Set By</th>
                                <th>Manual Override</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- LDAP Tab -->
            <div id="tabLdap" class="tabContent">
                <div class="card">
                    <h3>LDAP Integration Status</h3>
                    <div id="ldapStatus">Checking...</div>
                </div>

                <div class="card">
                    <h3>LDAP Group Mappings</h3>
                    <p class="description">Map LDAP groups to language alternatives. When a user logs in via LDAP, they will be automatically assigned the language of their highest-priority matching group.</p>
                    <table id="ldapGroupsTable">
                        <thead>
                            <tr>
                                <th>LDAP Group</th>
                                <th>Language</th>
                                <th>Priority</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="buttonRow">
                        <button class="btn btnPrimary" onclick="showAddLdapMappingModal()">Add Group Mapping</button>
                        <button class="btn btnSecondary" onclick="testLdapConnection()">Test Connection</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tabSettings" class="tabContent">
                <div class="card">
                    <h3>Language Sync Options</h3>
                    <div class="formGroup">
                        <label class="checkboxLabel">
                            <input type="checkbox" id="syncDisplayLanguage">
                            Sync User Display Language
                        </label>
                        <p class="description">Update the user's Jellyfin UI language when their plugin language changes.</p>
                    </div>
                    <div class="formGroup">
                        <label class="checkboxLabel">
                            <input type="checkbox" id="syncSubtitleLanguage">
                            Sync Subtitle Language Preference
                        </label>
                        <p class="description">Update the user's preferred subtitle language.</p>
                    </div>
                    <div class="formGroup">
                        <label class="checkboxLabel">
                            <input type="checkbox" id="syncAudioLanguage">
                            Sync Audio Language Preference
                        </label>
                        <p class="description">Update the user's preferred audio language.</p>
                    </div>
                </div>

                <div class="card">
                    <h3>LDAP Integration</h3>
                    <div class="formGroup">
                        <label class="checkboxLabel">
                            <input type="checkbox" id="enableLdapIntegration">
                            Enable LDAP Group-Based Assignment
                        </label>
                        <p class="description">Automatically assign language to new users based on their LDAP group membership.</p>
                    </div>
                </div>

                <div class="card">
                    <h3>Synchronization</h3>
                    <div class="formGroup">
                        <label>Mirror Sync Interval (hours)</label>
                        <input type="number" id="mirrorSyncInterval" min="1" max="168" value="6">
                        <p class="description">How often to run the scheduled sync task as a fallback. Mirrors are also synced automatically after library scans.</p>
                    </div>
                </div>

                <div class="buttonRow">
                    <button class="btn btnPrimary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Add Alternative Modal -->
        <div id="addAlternativeModal" class="modal">
            <div class="modalContent">
                <h3>Add Language Alternative</h3>
                <div class="formGroup">
                    <label>Name</label>
                    <input type="text" id="altName" placeholder="e.g., Portuguese">
                </div>
                <div class="formGroup">
                    <label>Language Code</label>
                    <input type="text" id="altLanguageCode" placeholder="e.g., pt-BR">
                </div>
                <div class="formGroup">
                    <label>Destination Base Path</label>
                    <input type="text" id="altDestPath" placeholder="e.g., /media/portuguese">
                </div>
                <div class="buttonRow">
                    <button class="btn btnPrimary" onclick="createAlternative()">Create</button>
                    <button class="btn btnSecondary" onclick="closeModal('addAlternativeModal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Mirror Modal -->
        <div id="addMirrorModal" class="modal">
            <div class="modalContent">
                <h3>Add Library Mirror</h3>
                <input type="hidden" id="mirrorAlternativeId">
                <div class="formGroup">
                    <label>Source Library</label>
                    <select id="mirrorSourceLibrary"></select>
                </div>
                <div class="formGroup">
                    <label>Target Path</label>
                    <input type="text" id="mirrorTargetPath" placeholder="Full path for mirror">
                </div>
                <div class="formGroup">
                    <label>Mirror Library Name (optional)</label>
                    <input type="text" id="mirrorLibraryName" placeholder="Leave empty for auto-generated name">
                </div>
                <div class="buttonRow">
                    <button class="btn btnPrimary" onclick="createMirror()">Create Mirror</button>
                    <button class="btn btnSecondary" onclick="closeModal('addMirrorModal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add LDAP Mapping Modal -->
        <div id="addLdapMappingModal" class="modal">
            <div class="modalContent">
                <h3>Add LDAP Group Mapping</h3>
                <div class="formGroup">
                    <label>LDAP Group DN or CN</label>
                    <input type="text" id="ldapGroupDn" placeholder="e.g., CN=PortugueseUsers,OU=Groups,DC=example,DC=com">
                </div>
                <div class="formGroup">
                    <label>Friendly Name (optional)</label>
                    <input type="text" id="ldapGroupName" placeholder="e.g., Portuguese Users">
                </div>
                <div class="formGroup">
                    <label>Language Alternative</label>
                    <select id="ldapLanguageAlt"></select>
                </div>
                <div class="formGroup">
                    <label>Priority</label>
                    <input type="number" id="ldapPriority" value="0" min="0">
                    <p class="description">Higher priority wins if user is in multiple groups.</p>
                </div>
                <div class="buttonRow">
                    <button class="btn btnPrimary" onclick="createLdapMapping()">Add Mapping</button>
                    <button class="btn btnSecondary" onclick="closeModal('addLdapMappingModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ApiClient = window.ApiClient;
        let libraries = [];
        let alternatives = [];
        let users = [];
        let ldapMappings = [];

        // Tab switching
        document.querySelectorAll('.tabButton').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tabButton').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tabContent').forEach(c => c.classList.remove('active'));
                button.classList.add('active');
                document.getElementById('tab' + capitalize(button.dataset.tab)).classList.add('active');
            });
        });

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadLibraries();
            loadAlternatives();
            loadUsers();
            loadLdapStatus();
            loadLdapMappings();
            loadSettings();
        });

        // API calls
        async function apiGet(endpoint) {
            const response = await ApiClient.fetch({ url: ApiClient.getUrl(endpoint), type: 'GET' });
            return response;
        }

        async function apiPost(endpoint, data) {
            return await ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data)
            });
        }

        async function apiPut(endpoint, data) {
            return await ApiClient.fetch({
                url: ApiClient.getUrl(endpoint),
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data)
            });
        }

        async function apiDelete(endpoint) {
            return await ApiClient.fetch({ url: ApiClient.getUrl(endpoint), type: 'DELETE' });
        }

        // Load data
        async function loadLibraries() {
            try {
                libraries = await apiGet('MultiLang/Libraries');
                renderLibraries();
            } catch (e) {
                console.error('Failed to load libraries', e);
            }
        }

        async function loadAlternatives() {
            try {
                alternatives = await apiGet('MultiLang/Alternatives');
                renderAlternatives();
            } catch (e) {
                console.error('Failed to load alternatives', e);
            }
        }

        async function loadUsers() {
            try {
                users = await apiGet('MultiLang/Users');
                renderUsers();
            } catch (e) {
                console.error('Failed to load users', e);
            }
        }

        async function loadLdapStatus() {
            try {
                const status = await apiGet('MultiLang/LdapStatus');
                renderLdapStatus(status);
            } catch (e) {
                document.getElementById('ldapStatus').innerHTML = '<span class="ldapStatusError">Failed to load status</span>';
            }
        }

        async function loadLdapMappings() {
            try {
                ldapMappings = await apiGet('MultiLang/LdapGroups');
                renderLdapMappings();
            } catch (e) {
                console.error('Failed to load LDAP mappings', e);
            }
        }

        async function loadSettings() {
            try {
                const settings = await apiGet('MultiLang/Settings');
                document.getElementById('syncDisplayLanguage').checked = settings.SyncUserDisplayLanguage;
                document.getElementById('syncSubtitleLanguage').checked = settings.SyncUserSubtitleLanguage;
                document.getElementById('syncAudioLanguage').checked = settings.SyncUserAudioLanguage;
                document.getElementById('enableLdapIntegration').checked = settings.EnableLdapIntegration;
                document.getElementById('mirrorSyncInterval').value = settings.MirrorSyncIntervalHours;
            } catch (e) {
                console.error('Failed to load settings', e);
            }
        }

        // Render functions
        function renderLibraries() {
            const tbody = document.querySelector('#librariesTable tbody');
            tbody.innerHTML = libraries.map(lib => `
                <tr>
                    <td>${lib.Name}</td>
                    <td>${lib.CollectionType || 'Unknown'}</td>
                    <td>${lib.PreferredMetadataLanguage || 'Default'} / ${lib.MetadataCountryCode || 'Default'}</td>
                    <td>${lib.IsMirror ? '<span class="statusBadge statusSynced">Mirror</span>' : 'Source'}</td>
                </tr>
            `).join('');
        }

        function renderAlternatives() {
            const container = document.getElementById('alternativesList');
            if (alternatives.length === 0) {
                container.innerHTML = '<p style="color:#888">No language alternatives configured yet.</p>';
                return;
            }

            container.innerHTML = alternatives.map(alt => `
                <div class="card" style="background:#222">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <h4 style="margin:0;color:#00a4dc">${alt.Name} (${alt.LanguageCode})</h4>
                        <div>
                            <button class="btn btnSecondary" onclick="syncAlternative('${alt.Id}')">Sync Now</button>
                            <button class="btn btnDanger" onclick="deleteAlternative('${alt.Id}')">Delete</button>
                        </div>
                    </div>
                    <p class="description">Base path: ${alt.DestinationBasePath}</p>
                    <h5 style="margin-top:1em">Mirrored Libraries</h5>
                    ${alt.MirroredLibraries.length === 0 ? '<p style="color:#888">No libraries mirrored yet.</p>' : `
                        <table>
                            <thead>
                                <tr><th>Source</th><th>Target</th><th>Status</th><th>Last Sync</th></tr>
                            </thead>
                            <tbody>
                                ${alt.MirroredLibraries.map(m => `
                                    <tr>
                                        <td>${m.SourceLibraryName}</td>
                                        <td>${m.TargetLibraryName}</td>
                                        <td><span class="statusBadge status${m.Status}">${m.Status}</span></td>
                                        <td>${m.LastSyncedAt ? new Date(m.LastSyncedAt).toLocaleString() : 'Never'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                    <button class="btn btnSecondary" style="margin-top:0.5em" onclick="showAddMirrorModal('${alt.Id}')">Add Library</button>
                </div>
            `).join('');
        }

        function renderUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.Username}${user.IsAdministrator ? ' (Admin)' : ''}</td>
                    <td>
                        <select onchange="setUserLanguage('${user.Id}', this.value)">
                            <option value="">None (All Libraries)</option>
                            ${alternatives.map(alt => `
                                <option value="${alt.Id}" ${user.AssignedAlternativeId === alt.Id ? 'selected' : ''}>${alt.Name}</option>
                            `).join('')}
                        </select>
                    </td>
                    <td>${user.SetBy || '-'}</td>
                    <td><input type="checkbox" ${user.ManuallySet ? 'checked' : ''} onchange="toggleManualOverride('${user.Id}', this.checked)"></td>
                    <td>
                        <button class="btn btnSecondary" onclick="clearUserLanguage('${user.Id}')">Clear</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderLdapStatus(status) {
            const container = document.getElementById('ldapStatus');
            let html = '<table>';
            html += `<tr><td>LDAP Plugin Installed</td><td>${status.IsPluginInstalled ? '<span class="ldapStatusOk">Yes</span>' : '<span class="ldapStatusError">No</span>'}</td></tr>`;
            html += `<tr><td>LDAP Configured</td><td>${status.IsConfigured ? '<span class="ldapStatusOk">Yes</span>' : '<span class="ldapStatusError">No</span>'}</td></tr>`;
            html += `<tr><td>Integration Enabled</td><td>${status.IsIntegrationEnabled ? '<span class="ldapStatusOk">Yes</span>' : '<span class="ldapStatusError">No</span>'}</td></tr>`;
            if (status.ServerAddress) {
                html += `<tr><td>Server</td><td>${status.ServerAddress}</td></tr>`;
            }
            if (status.ErrorMessage) {
                html += `<tr><td>Error</td><td><span class="ldapStatusError">${status.ErrorMessage}</span></td></tr>`;
            }
            html += '</table>';
            container.innerHTML = html;
        }

        function renderLdapMappings() {
            const tbody = document.querySelector('#ldapGroupsTable tbody');
            if (ldapMappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:#888">No LDAP group mappings configured.</td></tr>';
                return;
            }

            tbody.innerHTML = ldapMappings.map(mapping => {
                const alt = alternatives.find(a => a.Id === mapping.LanguageAlternativeId);
                return `
                    <tr>
                        <td title="${mapping.LdapGroupDn}">${mapping.LdapGroupName || mapping.LdapGroupDn}</td>
                        <td>${alt ? alt.Name : 'Unknown'}</td>
                        <td>${mapping.Priority}</td>
                        <td><button class="btn btnDanger" onclick="deleteLdapMapping('${mapping.Id}')">Delete</button></td>
                    </tr>
                `;
            }).join('');
        }

        // Actions
        async function createAlternative() {
            const name = document.getElementById('altName').value;
            const languageCode = document.getElementById('altLanguageCode').value;
            const destPath = document.getElementById('altDestPath').value;

            if (!name || !languageCode || !destPath) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await apiPost('MultiLang/Alternatives', { Name: name, LanguageCode: languageCode, DestinationBasePath: destPath });
                closeModal('addAlternativeModal');
                loadAlternatives();
            } catch (e) {
                alert('Failed to create alternative: ' + e.message);
            }
        }

        async function deleteAlternative(id) {
            if (!confirm('Are you sure you want to delete this language alternative?')) return;

            try {
                await apiDelete(`MultiLang/Alternatives/${id}?deleteLibraries=true&deleteFiles=false`);
                loadAlternatives();
            } catch (e) {
                alert('Failed to delete alternative: ' + e.message);
            }
        }

        async function syncAlternative(id) {
            try {
                await apiPost(`MultiLang/Alternatives/${id}/Sync`);
                alert('Sync started. Check the libraries list for status.');
                loadAlternatives();
            } catch (e) {
                alert('Failed to start sync: ' + e.message);
            }
        }

        function showAddMirrorModal(alternativeId) {
            document.getElementById('mirrorAlternativeId').value = alternativeId;
            const select = document.getElementById('mirrorSourceLibrary');
            select.innerHTML = libraries.filter(l => !l.IsMirror).map(lib =>
                `<option value="${lib.Id}">${lib.Name}</option>`
            ).join('');

            const alt = alternatives.find(a => a.Id === alternativeId);
            if (alt) {
                document.getElementById('mirrorTargetPath').placeholder = alt.DestinationBasePath + '/...';
            }

            showModal('addMirrorModal');
        }

        async function createMirror() {
            const altId = document.getElementById('mirrorAlternativeId').value;
            const sourceId = document.getElementById('mirrorSourceLibrary').value;
            const targetPath = document.getElementById('mirrorTargetPath').value;
            const libraryName = document.getElementById('mirrorLibraryName').value;

            if (!sourceId || !targetPath) {
                alert('Please fill in required fields');
                return;
            }

            try {
                await apiPost(`MultiLang/Alternatives/${altId}/Libraries`, {
                    SourceLibraryId: sourceId,
                    TargetPath: targetPath,
                    TargetLibraryName: libraryName || null
                });
                closeModal('addMirrorModal');
                loadAlternatives();
                loadLibraries();
            } catch (e) {
                alert('Failed to create mirror: ' + e.message);
            }
        }

        async function setUserLanguage(userId, alternativeId) {
            try {
                await apiPut(`MultiLang/Users/${userId}/Language`, {
                    AlternativeId: alternativeId || null,
                    ManuallySet: true
                });
                loadUsers();
            } catch (e) {
                alert('Failed to set user language: ' + e.message);
            }
        }

        async function clearUserLanguage(userId) {
            await setUserLanguage(userId, null);
        }

        async function toggleManualOverride(userId, isManual) {
            const user = users.find(u => u.Id === userId);
            if (!user) return;

            try {
                await apiPut(`MultiLang/Users/${userId}/Language`, {
                    AlternativeId: user.AssignedAlternativeId,
                    ManuallySet: isManual
                });
                loadUsers();
            } catch (e) {
                alert('Failed to update user: ' + e.message);
            }
        }

        function showAddLdapMappingModal() {
            const select = document.getElementById('ldapLanguageAlt');
            select.innerHTML = alternatives.map(alt =>
                `<option value="${alt.Id}">${alt.Name}</option>`
            ).join('');
            showModal('addLdapMappingModal');
        }

        async function createLdapMapping() {
            const groupDn = document.getElementById('ldapGroupDn').value;
            const groupName = document.getElementById('ldapGroupName').value;
            const langAltId = document.getElementById('ldapLanguageAlt').value;
            const priority = parseInt(document.getElementById('ldapPriority').value) || 0;

            if (!groupDn || !langAltId) {
                alert('Please fill in required fields');
                return;
            }

            try {
                await apiPost('MultiLang/LdapGroups', {
                    LdapGroupDn: groupDn,
                    LdapGroupName: groupName || null,
                    LanguageAlternativeId: langAltId,
                    Priority: priority
                });
                closeModal('addLdapMappingModal');
                loadLdapMappings();
            } catch (e) {
                alert('Failed to create LDAP mapping: ' + e.message);
            }
        }

        async function deleteLdapMapping(id) {
            if (!confirm('Are you sure you want to delete this LDAP mapping?')) return;

            try {
                await apiDelete(`MultiLang/LdapGroups/${id}`);
                loadLdapMappings();
            } catch (e) {
                alert('Failed to delete LDAP mapping: ' + e.message);
            }
        }

        async function testLdapConnection() {
            const username = prompt('Enter username to test (optional):');
            try {
                const result = await apiPost('MultiLang/TestLdap', { Username: username || null });
                alert(result.Message + (result.UserGroups ? '\n\nGroups: ' + result.UserGroups.join(', ') : ''));
            } catch (e) {
                alert('LDAP test failed: ' + e.message);
            }
        }

        async function saveSettings() {
            try {
                await apiPut('MultiLang/Settings', {
                    SyncUserDisplayLanguage: document.getElementById('syncDisplayLanguage').checked,
                    SyncUserSubtitleLanguage: document.getElementById('syncSubtitleLanguage').checked,
                    SyncUserAudioLanguage: document.getElementById('syncAudioLanguage').checked,
                    EnableLdapIntegration: document.getElementById('enableLdapIntegration').checked,
                    MirrorSyncIntervalHours: parseInt(document.getElementById('mirrorSyncInterval').value) || 6
                });
                alert('Settings saved successfully');
                loadLdapStatus();
            } catch (e) {
                alert('Failed to save settings: ' + e.message);
            }
        }

        // Modal helpers
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showAddAlternativeModal() {
            document.getElementById('altName').value = '';
            document.getElementById('altLanguageCode').value = '';
            document.getElementById('altDestPath').value = '';
            showModal('addAlternativeModal');
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>

